<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SinFiltro - Arena Vehicular (Modo Día/Noche)</title>
<style>
  html,body{height:100%;margin:0;background:#05060a;color:#eaf7ff;font-family:Inter,system-ui;overflow:hidden}
  #overlayUI{position:fixed;inset:0;pointer-events:none}
  #canvasHolder{width:100%;height:100%}
  .joy { position:fixed; left:18px; bottom:18px; width:110px; height:110px; border-radius:60px; background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; pointer-events:auto; z-index:30 }
  .stick { width:48px; height:48px; border-radius:50%; background:rgba(255,255,255,0.08); transform:translate(0,0) }
  .btnFire { position:fixed; right:20px; bottom:34px; width:72px; height:72px; border-radius:50%; background:linear-gradient(135deg,#00d1ff,#8a6eff); color:#001; font-weight:700; font-size:28px; display:flex; align-items:center; justify-content:center; pointer-events:auto; z-index:30; box-shadow:0 12px 40px rgba(0,0,0,0.5) }
  .topBar{position:fixed;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;align-items:center;pointer-events:auto;z-index:40}
  .logo{font-weight:700;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .miniBtns{display:flex;gap:8px}
  .icon{padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer}
  #btnToggleMode{position:fixed;right:20px;bottom:120px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#ffaa00,#ff5500);color:#fff;font-weight:800;font-size:20px;display:flex;align-items:center;justify-content:center;pointer-events:auto;z-index:35;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  #viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:50}
  #viewer img{max-width:90%;height:auto;border-radius:12px}
  @media(max-width:420px){ .joy{width:96px;height:96px} .stick{width:42px;height:42px} .btnFire{width:64px;height:64px} #btnToggleMode{width:56px;height:56px;font-size:18px}}
</style>
</head>
<body>
  <div id="canvasHolder"></div>

  <div id="overlayUI">
    <div class="topBar">
      <div class="logo">SinFiltro - Arena</div>
      <div class="miniBtns">
        <div class="icon" id="btnMenu">☰</div>
        <div class="icon" id="btnStart">▶</div>
      </div>
    </div>

    <div class="joy" id="joy"><div class="stick" id="stick"></div></div>
    <div class="btnFire" id="btnFire">🔫</div>
    <div id="btnToggleMode">🌙</div>
  </div>

  <div id="viewer"><div style="text-align:center">
    <img id="viewerImg" src="" alt="preview"><br><br>
    <button id="closeViewer" style="padding:8px 12px;border-radius:8px">Cerrar</button>
  </div></div>

  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script>
  (function(){
    const holder = document.getElementById('canvasHolder');
    const scene = new THREE.Scene();
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
    renderer.outputEncoding = THREE.sRGBEncoding;
    holder.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,2000);
    camera.position.set(0,6,10);

    // Lights
    const dirLight = new THREE.DirectionalLight(0xffffff,0.9);
    dirLight.position.set(5,10,7);
    scene.add(dirLight);
    const ambient = new THREE.AmbientLight(0xffffff,0.3);
    scene.add(ambient);

    // Textured ground
    const tex = new THREE.TextureLoader().load('https://tile.openstreetmap.org/14/4342/7514.png');
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
    tex.repeat.set(80,80);
    const groundMat = new THREE.MeshStandardMaterial({map:tex, roughness:1, metalness:0});
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(800,800),groundMat);
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Player car
    const car = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.7,4.2), new THREE.MeshStandardMaterial({color:0xff5555}));
    body.position.y=0.7; car.add(body);
    const wheelGeo = new THREE.CylinderGeometry(0.35,0.35,0.5,8);
    const wheelMat = new THREE.MeshStandardMaterial({color:0x111111});
    for(let i=0;i<4;i++){
      const w = new THREE.Mesh(wheelGeo,wheelMat);
      w.rotation.z=Math.PI/2; w.position.y=0.25;
      w.position.x=(i%2===0)?-1:1;
      w.position.z=(i<2)?1.2:-1.2;
      car.add(w);
    }
    scene.add(car);

    // Camera follow
    const camOffset=new THREE.Vector3(0,4,10);

    const state={forward:0,turn:0,speed:0,maxSpeed:0.9,rotSpeed:0.04};
    let lastTime=performance.now();

    // Joystick
    const joy=document.getElementById('joy'),stickEl=document.getElementById('stick');
    let stick={x:0,y:0};
    let baseX=0,baseY=0,md=false;
    function resetStick(){stick={x:0,y:0};stickEl.style.transform=`translate(0,0)`;}
    joy.addEventListener('pointerdown',e=>{md=true;baseX=e.clientX;baseY=e.clientY;joy.setPointerCapture(e.pointerId);});
    joy.addEventListener('pointermove',e=>{
      if(!md)return;
      const dx=e.clientX-baseX,dy=e.clientY-baseY,max=36;
      const nx=Math.max(-1,Math.min(1,dx/max)),ny=Math.max(-1,Math.min(1,dy/max));
      stick.x=nx;stick.y=-ny;
      stickEl.style.transform=`translate(${nx*28}px,${-ny*28}px)`;
    });
    joy.addEventListener('pointerup',()=>{md=false;resetStick();});

    // Fire
    const fireBtn=document.getElementById('btnFire');
    fireBtn.addEventListener('click',()=>doFire());
    const bullets=[];
    function doFire(){
      const dir=new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion).normalize();
      const origin=car.position.clone().add(new THREE.Vector3(0,1,-2).applyQuaternion(car.quaternion));
      const b=new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8),new THREE.MeshStandardMaterial({emissive:0xffcc77}));
      b.position.copy(origin);b.userData.dir=dir;b.userData.speed=2.2;scene.add(b);bullets.push(b);
    }

    // Resize
    window.addEventListener('resize',()=>{renderer.setSize(innerWidth,innerHeight);camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();});

    // Día/Noche toggle
    let isNight=false;
    const btnToggle=document.getElementById('btnToggleMode');
    function setDayNight(night){
      isNight=night;
      if(night){
        scene.background=new THREE.Color(0x03040a);
        dirLight.intensity=0.3;ambient.intensity=0.1;
        groundMat.color.set(0x222233);
        btnToggle.textContent="☀️";
      }else{
        scene.background=new THREE.Color(0x99ccff);
        dirLight.intensity=0.9;ambient.intensity=0.4;
        groundMat.color.set(0xffffff);
        btnToggle.textContent="🌙";
      }
    }
    btnToggle.addEventListener('click',()=>setDayNight(!isNight));
    setDayNight(true); // inicia noche

    // Loop
    function animate(){
      const now=performance.now();const dt=Math.min(50,now-lastTime)/16.666;lastTime=now;
      state.forward=Math.max(-1,Math.min(1,stick.y));
      state.turn=Math.max(-1,Math.min(1,stick.x));
      if(state.forward>0.05)state.speed+=0.02*state.forward*dt;
      else if(state.forward<-0.05)state.speed-=0.03*(-state.forward)*dt;
      else state.speed*=0.98;
      state.speed=Math.max(-state.maxSpeed,Math.min(state.maxSpeed,state.speed));
      car.rotation.y+=-state.turn*state.rotSpeed*(0.9+Math.abs(state.speed))*dt;
      const forwardVec=new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion);
      car.position.add(forwardVec.multiplyScalar(state.speed*dt*0.8));
      const desiredCam=car.position.clone().add(new THREE.Vector3(0,4,10).applyQuaternion(car.quaternion));
      camera.position.lerp(desiredCam,0.12);
      const lookAt=car.position.clone().add(new THREE.Vector3(0,1.5,0));
      camera.lookAt(lookAt);
      for(let i=bullets.length-1;i>=0;i--){
        const b=bullets[i];
        b.position.add(b.userData.dir.clone().multiplyScalar(b.userData.speed*dt));
        if(b.position.length()>1000){scene.remove(b);bullets.splice(i,1);}
      }
      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  })();
  </script>
</body>
</html>
