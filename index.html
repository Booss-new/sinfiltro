<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SinFiltro - Pro App Móvil</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ====================================================================
           ESTILOS CSS: COMPRIMIDOS PARA UN SOLO ARCHIVO
           ==================================================================== */
        :root {
            --primary: #FF4500; /* Naranja/Rojo Vivo */
            --secondary: #00BFFF; /* Azul Claro */
            --background: #121212;
            --surface: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --muted: #444444;
            --shadow: rgba(0, 0, 0, 0.4);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 60px; /* Espacio para el Navbar */
            overflow-x: hidden;
            -webkit-user-select: none; /* Deshabilitar selección en iOS */
            user-select: none; /* Deshabilitar selección general */
            overscroll-behavior-y: none; /* Evitar el "pull to refresh" */
        }
        .container {
            padding: 0 10px;
        }
        h2 {
            font-size: 1.5rem;
            margin: 20px 0 10px 0;
            padding-left: 5px;
            border-left: 3px solid var(--primary);
        }

        /* ------------------ Navbar ------------------ */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--surface);
            border-top: 1px solid var(--muted);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        .nav-item {
            color: var(--text-secondary);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 5px 15px;
            transition: color 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            color: var(--primary);
        }
        .nav-item.upload-btn {
            font-size: 2.5rem;
            color: var(--text-primary);
            background-color: var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translateY(-10px);
            box-shadow: 0 4px 8px var(--shadow);
        }
        .nav-item.upload-btn:active {
            transform: translateY(-10px) scale(0.95);
        }
        /* ------------------ Header ------------------ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            background-color: var(--surface);
            box-shadow: 0 2px 4px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        .header-icons {
            display: flex;
            gap: 15px;
        }
        .header-icon {
            font-size: 1.4rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        /* ------------------ Feed ------------------ */
        .feed-section {
            padding: 10px 0;
        }
        .scroll-row {
            display: flex;
            overflow-x: scroll;
            gap: 15px;
            padding: 10px 10px 10px 10px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            cursor: grab;
        }
        .scroll-row::-webkit-scrollbar {
            display: none;
        }
        .scroll-row-wrapper {
            position: relative;
        }
        /* ------------------ Card (Small) ------------------ */
        .small-card {
            flex-shrink: 0;
            width: 180px; /* Ancho fijo para móvil */
            height: 250px;
            background-color: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow);
            position: relative;
            scroll-snap-align: start;
        }
        .small-card img, .small-card video {
            width: 100%;
            height: 70%;
            object-fit: cover;
            display: block;
            background-color: var(--muted);
        }
        .small-card-info {
            padding: 8px;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .small-card-title {
            font-size: 1rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .small-card-stats {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        .icon-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--text-primary);
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        /* ------------------ Grid Feed ------------------ */
        .grid-feed {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            padding: 3px;
        }
        .grid-card {
            aspect-ratio: 1 / 1;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        .grid-card img, .grid-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s;
            background-color: var(--muted);
        }
        .grid-card:active img {
            transform: scale(0.98);
        }
        /* ------------------ Modales ------------------ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--surface);
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        .modal.open {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid var(--muted);
        }
        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
        }
        .close-btn {
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .modal-content {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
        }
        /* -- Subir Archivo Modal -- */
        #uploadModal .modal-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .drop-area {
            border: 2px dashed var(--muted);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .drop-area.drag-over {
            background-color: var(--muted);
        }
        #fileInput {
            display: none;
        }
        .file-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            object-fit: contain;
            display: none;
        }
        input[type="text"] {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--muted);
            color: var(--text-primary);
            font-size: 1rem;
            width: 100%;
        }
        .progress-bar-container {
            height: 10px;
            background-color: var(--muted);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary);
            transition: width 0.1s;
        }
        .upload-button {
            padding: 12px;
            background-color: var(--secondary);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .upload-button:disabled {
            background-color: var(--muted);
            cursor: not-allowed;
        }
        /* -- Search Modal -- */
        .search-input-container {
            position: relative;
            margin-bottom: 15px;
        }
        #searchInput {
            padding-left: 40px;
        }
        .search-input-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        .search-mini-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .search-mini-grid .mini-thumb {
            aspect-ratio: 1 / 1;
            overflow: hidden;
            border-radius: 5px;
        }
        .search-mini-grid .mini-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: var(--muted);
        }
        /* -- My Modal -- */
        .my-profile-info {
            text-align: center;
            padding: 15px 0 20px 0;
            border-bottom: 1px solid var(--muted);
            margin-bottom: 10px;
        }
        .my-profile-info i {
            font-size: 3rem;
            color: var(--secondary);
        }
        .my-profile-info h3 {
            margin: 5px 0 0 0;
        }
        .my-profile-info p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .my-profile-buttons {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        .my-profile-buttons button {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
        }
        .my-profile-buttons button.logout {
            border-color: var(--muted);
            color: var(--text-secondary);
        }
        .my-content-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
        }
        /* -- Viewer Modal -- */
        #viewerModal {
            background-color: var(--background);
            transition: opacity 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
            justify-content: center;
            align-items: center;
        }
        #viewerModal.open {
            opacity: 1;
            pointer-events: all;
        }
        .viewer-content {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        .viewer-card {
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Alinear contenido abajo */
            position: relative;
        }
        .viewer-scroll-container {
            width: 100%;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
        }
        .viewer-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background-color: var(--muted);
        }
        .viewer-overlay {
            position: relative;
            z-index: 2;
            padding: 20px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0) 100%);
            color: var(--text-primary);
        }
        .viewer-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 10px;
        }
        .viewer-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .viewer-user {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        .viewer-stats {
            text-align: right;
        }
        .viewer-stats div {
            font-size: 1rem;
            margin-top: 5px;
        }
        .viewer-stats i {
            margin-right: 5px;
        }
        #viewerCloseBtn {
            position: absolute;
            top: 40px;
            left: 15px;
            font-size: 2rem;
            color: var(--text-primary);
            z-index: 5;
            text-shadow: 0 0 5px var(--shadow);
            cursor: pointer;
        }
        
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">SinFiltro</div>
        <div class="header-icons">
            <i class="fas fa-bell header-icon"></i>
            <i class="fas fa-search header-icon" id="openSearchModalBtn"></i>
        </div>
    </header>

    <main class="container">

        <section class="feed-section">
            <h2>🔥 Tendencias</h2>
            <div class="scroll-row-wrapper">
                <div class="scroll-row" id="trend-row-1"></div>
            </div>
            <div class="scroll-row-wrapper">
                <div class="scroll-row" id="trend-row-2"></div>
            </div>
        </section>

        <section class="feed-section">
            <h2>🌟 Recomendados</h2>
            <div class="scroll-row-wrapper">
                <div class="scroll-row" id="reco-row-1"></div>
            </div>
            <div class="scroll-row-wrapper">
                <div class="scroll-row" id="reco-row-2"></div>
            </div>
        </section>

        <section class="feed-section">
            <h2>🌍 Explorar</h2>
            <div class="grid-feed" id="grid-feed">
                </div>
        </section>

    </main>

    <nav class="navbar">
        <i class="fas fa-home nav-item active"></i>
        <i class="fas fa-heart nav-item"></i>
        <div class="nav-item upload-btn" id="openUploadModalBtn"><i class="fas fa-plus"></i></div>
        <i class="fas fa-comment-dots nav-item"></i>
        <i class="fas fa-user nav-item" id="openMyModalBtn"></i>
    </nav>

    <div class="modal" id="uploadModal">
        <div class="modal-header">
            <h2 class="modal-title">Subir Contenido</h2>
            <i class="fas fa-times close-btn" id="closeUploadModalBtn"></i>
        </div>
        <div class="modal-content">
            <input type="text" id="uploadTitle" placeholder="Título para tu video o foto (opcional)">
            
            <div class="drop-area" id="dropArea">
                <input type="file" id="fileInput" accept="image/*,video/*">
                <p>Arrastra y suelta aquí, o haz click para seleccionar un archivo (máx. 10MB)</p>
                <img id="filePreviewImage" class="file-preview" alt="Vista previa">
                <video id="filePreviewVideo" class="file-preview" controls muted></video>
                <p id="fileNameDisplay" style="font-size:0.8rem; color:var(--primary); margin-top:5px;"></p>
            </div>

            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <button class="upload-button" id="uploadButton" disabled>Subir</button>
        </div>
    </div>

    <div class="modal" id="searchModal">
        <div class="modal-header">
            <h2 class="modal-title">Buscar</h2>
            <i class="fas fa-times close-btn" id="closeSearchModalBtn"></i>
        </div>
        <div class="modal-content">
            <div class="search-input-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Explorar videos, usuarios, tags...">
            </div>
            
            <h3>Sugerencias Populares</h3>
            <div class="search-mini-grid" id="searchMini">
                </div>
        </div>
    </div>

    <div class="modal" id="myModal">
        <div class="modal-header">
            <h2 class="modal-title">Mi Perfil</h2>
            <i class="fas fa-times close-btn" id="closeMyModalBtn"></i>
        </div>
        <div class="modal-content">
            <div id="myProfileContent">
                </div>
            
            <div id="myContentSection" style="margin-top:20px;">
                <h3>Mi Contenido</h3>
                <div class="my-content-grid" id="myGrid">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal" id="viewerModal">
        <i class="fas fa-times" id="viewerCloseBtn"></i>
        <div class="viewer-scroll-container">
            </div>
    </div>


    <script>
    
    /* ====================================================================
       FASE 3: OBJETO DE CONEXIÓN AL BACKEND REAL (USA FETCH)
       ==================================================================== */

    const BASE_URL = '/api'; // Apunta al servidor Express
    let userToken = localStorage.getItem('sf.token') || null;

    window.API = {
        // 1. Obtiene datos del feed del Backend (server.js)
        getFeed: async (type) => {
            try {
                // Llama al endpoint REAL: /api/content/feed/trends, /api/content/feed/reco, etc.
                const response = await fetch(`${BASE_URL}/content/feed/${type}`);
                if (!response.ok) throw new Error(`Error ${response.status} al obtener el feed`);
                
                const result = await response.json();
                return result.data || [];
                
            } catch (error) {
                console.error(`Error en getFeed (${type}):`, error.message);
                return [];
            }
        },
        
        // 2. Simulación de Autenticación (para que el botón Login funcione temporalmente)
        getCurrentUser: () => {
            return userToken ? { id: 'u_real', username: 'TestUser' } : null;
        },
        
        login: async (email, password) => { 
            // Credenciales de prueba temporales: test@sf.com / 1234
            await new Promise(r => setTimeout(r, 500)); 
            if (email === 'test@sf.com' && password === '1234') {
                userToken = 'real_token_123';
                localStorage.setItem('sf.token', userToken);
                return { success: true, user: { username: 'TestUser' } };
            }
            return { success: false, message: 'Credenciales de prueba inválidas.' };
        },
        
        logout: () => {
            userToken = null;
            localStorage.removeItem('sf.token');
        },

        // 3. Simulación de Subida (hasta conectar S3/Cloudinary)
        uploadFile: async (file, title) => {
            await new Promise(r => setTimeout(r, 2000));
            return { 
                success: true, 
                item: { 
                    id: Date.now(), 
                    title: title || file.name, 
                    src: 'https://picsum.photos/640/420?realupload', 
                    kind: file.type.startsWith('video') ? 'video' : 'image',
                    likes: 0, comments: 0, views: '0K',
                    userId: 'u_real'
                } 
            };
        },

        // 4. Implementación temporal para llenar los modales (Mis videos, Buscar)
        getFallbackContent: async () => {
            const result = await window.API.getFeed('grid');
            return result.slice(0, 12); 
        }
    };

    const API = window.API; 
    // Objeto vacío para compatibilidad con las funciones antiguas que lo usaban
    window.DATA_STORE = { content: [] }; 

    /* ====================================================================
       FRONTEND: MANEJO DE VISTAS Y DOM
       ==================================================================== */
    
    // Selectores de DOM
    const trendRow1 = document.getElementById('trend-row-1');
    const trendRow2 = document.getElementById('trend-row-2');
    const recoRow1 = document.getElementById('reco-row-1');
    const recoRow2 = document.getElementById('reco-row-2');
    const gridFeed = document.getElementById('grid-feed');
    const uploadModal = document.getElementById('uploadModal');
    const myModal = document.getElementById('myModal');
    const viewerModal = document.getElementById('viewerModal');
    const viewerScrollContainer = viewerModal.querySelector('.viewer-scroll-container');
    const searchModal = document.getElementById('searchModal');
    const searchMini = document.getElementById('searchMini');
    const myGrid = document.getElementById('myGrid');
    const myProfileContent = document.getElementById('myProfileContent');

    // Estado del Viewer
    let activeList = [];
    let currentIndex = 0;

    // Utilidad
    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    /* ---------- Tarjetas y Elementos del DOM ---------- */

    function makeSmallCard(item) {
        const card = document.createElement('div');
        card.className = 'small-card';
        card.setAttribute('data-id', item.id);
        
        let mediaHtml = '';
        const icon = (item.kind === 'video') ? '<i class="fas fa-video"></i>' : '<i class="fas fa-image"></i>';

        if (item.kind === 'video') {
            mediaHtml = `<video class="lazy" data-src="${item.src}" muted preload="none"></video>`;
        } else {
            mediaHtml = `<img class="lazy" data-src="${item.src}" alt="${escapeHtml(item.title)}">`;
        }

        card.innerHTML = `
            ${mediaHtml}
            <div class="icon-overlay">${icon}</div>
            <div class="small-card-info">
                <div class="small-card-title">${escapeHtml(item.title)}</div>
                <div class="small-card-stats">
                    <span><i class="fas fa-eye"></i> ${item.views}</span>
                    <span><i class="fas fa-heart"></i> ${item.likes}</span>
                </div>
            </div>
        `;

        card.addEventListener('click', () => {
            openViewerByItem(item);
        });

        return card;
    }

    function makeGridCard(item) {
        const card = document.createElement('div');
        card.className = 'grid-card';
        card.setAttribute('data-id', item.id);
        
        const icon = (item.kind === 'video') ? '<i class="fas fa-video icon-overlay"></i>' : '';

        card.innerHTML = `
            <img class="lazy" data-src="${item.src}" alt="${escapeHtml(item.title)}">
            ${icon}
        `;

        card.addEventListener('click', () => {
            openViewerByItem(item);
        });

        return card;
    }
    
    function makeViewerCard(item) {
        const card = document.createElement('div');
        card.className = 'viewer-card';
        card.setAttribute('data-id', item.id);
        card.setAttribute('data-kind', item.kind);
        
        let mediaHtml;
        if (item.kind === 'video') {
            mediaHtml = `<video class="viewer-media" src="${item.src}" controls loop></video>`;
        } else {
            mediaHtml = `<img class="viewer-media" src="${item.src}" alt="${escapeHtml(item.title)}">`;
        }

        card.innerHTML = `
            ${mediaHtml}
            <div class="viewer-overlay">
                <div class="viewer-title">${escapeHtml(item.title)}</div>
                <div class="viewer-user"><i class="fas fa-user-circle"></i> @${item.userId || 'usuario_sf'}</div>
                <div class="viewer-info">
                    <div style="font-size:0.9rem; color:var(--text-secondary);">${item.comments} Comentarios</div>
                    <div class="viewer-stats">
                        <div><i class="fas fa-eye"></i> ${item.views}</div>
                        <div><i class="fas fa-heart"></i> ${item.likes}</div>
                    </div>
                </div>
            </div>
        `;

        return card;
    }


    /* ---------- Funciones de Lazy Loading ---------- */

    function lazyObserve() {
        const lazyElements = document.querySelectorAll('.lazy');
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const src = el.getAttribute('data-src');
                    if (el.tagName === 'IMG') {
                        el.src = src;
                    } else if (el.tagName === 'VIDEO') {
                        el.src = src;
                        el.load(); // Asegurar que el video se cargue
                    }
                    el.classList.remove('lazy');
                    el.removeAttribute('data-src');
                    observer.unobserve(el);
                }
            });
        }, {
            rootMargin: '100px 0px', // Carga antes de entrar a la vista
            threshold: 0.01
        });

        lazyElements.forEach(el => observer.observe(el));
    }


    /* ---------- Funciones de Scroll y Drag ---------- */

    function enableDragScroll(element) {
        let isDown = false;
        let startX;
        let scrollLeft;

        element.addEventListener('mousedown', (e) => {
            isDown = true;
            element.classList.add('active');
            startX = e.pageX - element.offsetLeft;
            scrollLeft = element.scrollLeft;
        });

        element.addEventListener('mouseleave', () => {
            isDown = false;
            element.classList.remove('active');
        });

        element.addEventListener('mouseup', () => {
            isDown = false;
            element.classList.remove('active');
        });

        element.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - element.offsetLeft;
            const walk = (x - startX) * 1.5; // Velocidad de arrastre
            element.scrollLeft = scrollLeft - walk;
        });
        
        // Manejo táctil para dispositivos móviles
        element.addEventListener('touchstart', (e) => {
            isDown = true;
            startX = e.touches[0].pageX - element.offsetLeft;
            scrollLeft = element.scrollLeft;
        });

        element.addEventListener('touchmove', (e) => {
            if (!isDown) return;
            const x = e.touches[0].pageX - element.offsetLeft;
            const walk = (x - startX) * 1.5;
            element.scrollLeft = scrollLeft - walk;
        });

        element.addEventListener('touchend', () => {
            isDown = false;
        });
    }


    /* ---------- Funciones de Renderizado Principal (Usan API) ---------- */

    async function renderTwoRows(row1, row2, type){
        row1.innerHTML = ''; row2.innerHTML = '';
        
        // Llama a la API real
        const items = await API.getFeed(type); 

        items.forEach((it, i) => {
            const target = (i % 2 === 0) ? row1 : row2;
            target.appendChild(makeSmallCard(it));
        });

        [row1, row2].forEach(r => {
            enableDragScroll(r);
        });
        lazyObserve();
    }

    async function renderGridInitial(){
        gridFeed.innerHTML = '';
        // Llama a la API real
        const items = await API.getFeed('grid'); 
        items.forEach(it => gridFeed.appendChild(makeGridCard(it)));
        lazyObserve(gridFeed);
    }
    
    function renderAll() {
        renderTwoRows(trendRow1, trendRow2, 'trends');
        renderTwoRows(recoRow1, recoRow2, 'reco');
        renderGridInitial();
        setupModals();
        updateMyModalContent();
    }


    /* ---------- Funciones del Visor (Viewer) ---------- */

    function showViewer() {
        viewerScrollContainer.innerHTML = '';
        activeList.forEach(item => {
            viewerScrollContainer.appendChild(makeViewerCard(item));
        });
        
        // Scroll al elemento inicial
        viewerScrollContainer.scrollTop = currentIndex * viewerScrollContainer.offsetHeight;

        viewerModal.classList.add('open');
        document.body.style.overflow = 'hidden'; // Bloquea el scroll de fondo
    }

    function closeViewer() {
        viewerModal.classList.remove('open');
        document.body.style.overflow = '';
        // Pausar cualquier video activo
        viewerScrollContainer.querySelectorAll('video').forEach(v => v.pause());
    }

    function openViewerByItem(item){
        // Usamos el feed 'grid' como la lista activa para el scroll vertical del visor
        API.getFeed('grid').then(items => {
            activeList = items; 
            currentIndex = activeList.findIndex(x => x.id === item.id);
            showViewer();
        });
    }

    /* ---------- Funciones de Modales (Lógica) ---------- */

    // --- Lógica de Modales de Perfil y Login ---

    function renderLoginForm() {
        return `
            <div class="my-profile-info">
                <i class="fas fa-lock"></i>
                <h3>Inicia Sesión</h3>
                <p>Accede a tu contenido y funcionalidades pro.</p>
            </div>
            <div style="padding: 10px;">
                <input type="text" id="loginEmail" placeholder="Correo (test@sf.com)">
                <input type="password" id="loginPassword" placeholder="Contraseña (1234)" style="margin-top:10px;">
                <p id="loginError" style="color: var(--primary); font-size: 0.9rem; text-align: center; margin-top: 10px; display: none;">Error de credenciales.</p>
                <button class="upload-button" style="background-color: var(--secondary); margin-top:15px;" id="loginBtn">Entrar</button>
            </div>
            <p style="text-align:center; font-size:0.9rem; color:var(--text-secondary);">¿No tienes cuenta? <a href="#" style="color:var(--primary);">Regístrate</a></p>
        `;
    }

    function renderProfileInfo(user) {
        return `
            <div class="my-profile-info">
                <i class="fas fa-user-circle"></i>
                <h3>@${user.username}</h3>
                <p>Miembro Pro desde hoy</p>
            </div>
            <div class="my-profile-buttons">
                <button>Editar Perfil</button>
                <button class="logout" id="logoutBtn">Cerrar Sesión</button>
            </div>
        `;
    }

    async function updateMyModalContent() {
        const user = API.getCurrentUser();
        if (user) {
            myProfileContent.innerHTML = renderProfileInfo(user);
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                API.logout();
                updateMyModalContent();
                await openMyModal(); // Vuelve a renderizar el modal
            });
            await openMyModal(true); // Carga la grilla del contenido
        } else {
            myProfileContent.innerHTML = renderLoginForm();
            document.getElementById('loginBtn').addEventListener('click', async (e) => {
                e.target.disabled = true;
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDisplay = document.getElementById('loginError');

                const result = await API.login(email, password);

                if (result.success) {
                    errorDisplay.style.display = 'none';
                    updateMyModalContent();
                } else {
                    errorDisplay.style.display = 'block';
                    e.target.disabled = false;
                }
            });
            await openMyModal(false); // Vacía la grilla del contenido
        }
    }

    async function openMyModal(isLoggedIn) {
        myModal.classList.add('open');
        
        // Lógica para cargar el contenido
        myGrid.innerHTML = '';
        const userContent = await API.getFallbackContent(); 
        
        if (!isLoggedIn) {
            myGrid.innerHTML = '<p style="text-align:center; color:var(--muted); grid-column: 1 / -1; margin-top: 15px;">Inicia sesión para ver tu contenido.</p>';
        } else if (userContent.length === 0) {
            myGrid.innerHTML = '<p style="text-align:center; color:var(--muted); grid-column: 1 / -1; margin-top: 15px;">Aún no has subido contenido. ¡Sube algo!</p>';
        }

        for(let i=0;i<Math.min(9, userContent.length);i++){
            const it = userContent[i];
            myGrid.appendChild(makeGridCard(it));
        }
    }

    // --- Lógica del Modal de Búsqueda ---
    
    function closeSearchModal() {
        searchModal.classList.remove('open');
    }

    async function populateSearchMini(){
      searchMini.innerHTML = '';
      // Usamos el fallback para llenar las sugerencias iniciales
      const content = await API.getFallbackContent();

      for(let i=0;i<Math.min(12, content.length);i++){
        const item = content[i];
        const d = document.createElement('div'); d.className='mini-thumb';
        d.innerHTML = `<img src="${item.src}" alt="${escapeHtml(item.title)}">`;
        d.addEventListener('click', ()=>{ openViewerByItem(item); closeSearchModal(); });
        searchMini.appendChild(d);
      }
    }


    /* ---------- Setup de Eventos de la UI ---------- */

    function setupModals() {
        // Eventos de botones de apertura
        document.getElementById('openUploadModalBtn').addEventListener('click', () => uploadModal.classList.add('open'));
        document.getElementById('openMyModalBtn').addEventListener('click', () => {
            updateMyModalContent();
            myModal.classList.add('open');
        });
        document.getElementById('openSearchModalBtn').addEventListener('click', () => {
            populateSearchMini();
            searchModal.classList.add('open');
        });
        
        // Eventos de cierre
        document.getElementById('closeUploadModalBtn').addEventListener('click', () => uploadModal.classList.remove('open'));
        document.getElementById('closeMyModalBtn').addEventListener('click', () => myModal.classList.remove('open'));
        document.getElementById('closeSearchModalBtn').addEventListener('click', closeSearchModal);
        document.getElementById('viewerCloseBtn').addEventListener('click', closeViewer);


        // --- Lógica de Subida de Archivos ---
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const uploadButton = document.getElementById('uploadButton');
        const uploadTitle = document.getElementById('uploadTitle');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const filePreviewImage = document.getElementById('filePreviewImage');
        const filePreviewVideo = document.getElementById('filePreviewVideo');
        let selectedFile = null;

        function updatePreview(file) {
            if (file) {
                selectedFile = file;
                const url = URL.createObjectURL(file);
                fileNameDisplay.textContent = file.name;
                uploadButton.disabled = false;
                
                // Mostrar preview
                filePreviewImage.style.display = 'none';
                filePreviewVideo.style.display = 'none';

                if (file.type.startsWith('image/')) {
                    filePreviewImage.src = url;
                    filePreviewImage.style.display = 'block';
                } else if (file.type.startsWith('video/')) {
                    filePreviewVideo.src = url;
                    filePreviewVideo.style.display = 'block';
                }

            } else {
                selectedFile = null;
                uploadButton.disabled = true;
                fileNameDisplay.textContent = 'Arrastra y suelta aquí, o haz click para seleccionar un archivo (máx. 10MB)';
                filePreviewImage.style.display = 'none';
                filePreviewVideo.style.display = 'none';
            }
        }
        
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => updatePreview(e.target.files[0]));

        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
        });

        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            updatePreview(file);
        }, false);

        uploadButton.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            // Simulación de carga
            progressBarContainer.style.display = 'block';
            uploadButton.disabled = true;
            
            const title = uploadTitle.value;
            
            // Simulación de progreso
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                if (progress >= 100) clearInterval(interval);
            }, 100);

            // Llama a la API (Simulación)
            const result = await API.uploadFile(selectedFile, title);
            
            clearInterval(interval);
            progressBar.style.width = '100%';
            progressBarContainer.style.display = 'none';
            uploadButton.disabled = false;
            
            if (result.success) {
                alert('¡Contenido subido con éxito!');
                uploadModal.classList.remove('open');
                updatePreview(null); // Limpia la interfaz
                uploadTitle.value = '';
                renderAll(); // Vuelve a cargar el feed para ver el nuevo contenido (simulado)
            } else {
                alert('Error al subir contenido.');
            }
        });

    }


    /* ---------- Initializers ---------- */
    document.addEventListener('DOMContentLoaded', ()=> {
        renderAll();
    });

    </script>
</body>
</html>
