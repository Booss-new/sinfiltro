<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Metal Streets ‚Äî Arena Libre (Demo M√≥vil)</title>
<style>
  :root{
    --bg:#04050a; --panel: rgba(20,20,30,0.7);
    --accent1:#00d1ff; --accent2:#8a6eff; --muted:#9fb0bf;
  }
  html,body{height:100%;margin:0;background:linear-gradient(#02020a,#060a1a);font-family:Inter,system-ui,Arial;color:#eaf7ff;overflow:hidden;-webkit-font-smoothing:antialiased}
  #holder{width:100%;height:100%;position:relative;touch-action:none}

  /* HUD */
  .hud{position:fixed;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;z-index:200;pointer-events:none}
  .panel{background:var(--panel);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);pointer-events:auto;display:flex;align-items:center;gap:10px}
  .panel .title{font-weight:700;color:var(--accent2);font-size:13px}
  .bar{height:12px;background:rgba(255,255,255,0.06);border-radius:6px;width:140px;overflow:hidden}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:100%;transition:width .18s}

  /* speed */
  .speed{position:fixed;right:12px;bottom:120px;width:112px;height:112px;border-radius:999px;background:var(--panel);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:190;pointer-events:none}
  .speed .val{font-size:30px;font-weight:800}

  /* joystick and buttons */
  .joy{position:fixed;left:12px;bottom:12px;width:110px;height:110px;border-radius:999px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;z-index:190;pointer-events:auto;border:1px solid rgba(255,255,255,0.03)}
  .stick{width:48px;height:48px;border-radius:999px;background:rgba(255,255,255,0.07)}
  .fire{position:fixed;right:18px;bottom:18px;width:76px;height:76px;border-radius:999px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:30px;color:#001;z-index:190;pointer-events:auto;border:1px solid rgba(255,255,255,0.06);box-shadow:0 18px 60px rgba(0,0,0,0.55)}
  .fire.cool{opacity:.6;transform:scale(.96);pointer-events:none}
  .turbo{position:fixed;right:110px;bottom:28px;width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;z-index:190;pointer-events:auto;border:1px solid rgba(255,255,255,0.03)}

  /* fps/info */
  .fps{position:fixed;left:12px;bottom:140px;background:var(--panel);padding:6px 8px;border-radius:8px;font-weight:700;z-index:190}
  #loading{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:300;background:rgba(0,0,0,0.6);padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  @media(max-width:420px){
    .joy{width:92px;height:92px}
    .stick{width:40px;height:40px}
    .fire{width:64px;height:64px}
    .speed{right:8px;bottom:100px}
  }
</style>
</head>
<body>
  <div id="holder"></div>

  <div class="hud">
    <div class="panel" style="gap:12px">
      <div style="display:flex;flex-direction:column">
        <div class="title">SALUD</div>
        <div class="bar" style="margin-top:6px"><i id="healthBar" style="width:100%"></i></div>
      </div>
      <div style="display:flex;flex-direction:column">
        <div class="title">MUNICI√ìN</div>
        <div class="bar" style="margin-top:6px"><i id="ammoBar" style="width:100%"></i></div>
      </div>
    </div>

    <div class="panel" style="gap:10px">
      <div class="title" id="carLabel">MUSCLE ‚Ä¢ DEMO</div>
      <div style="font-weight:700;color:var(--muted)">ARENA: LIBRE</div>
    </div>
  </div>

  <div class="speed"><div style="font-size:12px;color:var(--muted)">VELOCIDAD</div><div class="val" id="speedVal">0</div></div>
  <div id="loading">Cargando escena‚Ä¶</div>
  <div class="joy" id="joy"><div class="stick" id="stick"></div></div>
  <div class="fire" id="fire">üî´</div>
  <div class="turbo" id="turbo">üèÅ</div>
  <div class="fps" id="fps">FPS: --</div>

  <!-- Three.js + postprocessing (CDN) -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
/*
  Metal Streets - Arena Libre (versi√≥n m√≥vil-optimizada)
  - Arena cerrado
  - Carro tipo Muscle (b√°sico, low-poly)
  - Joystick/touch, fire, turbo
  - Bullets object pool
  - Basic AI cars
  - Soft collisions with arena bounds
  - FPS counter, HUD updates
  - Lightweight: no heavy textures, suitable for mobile testing
*/
(async function(){
  // ---------- escena / renderer ----------
  const holder = document.getElementById('holder');
  const W = window.innerWidth, H = window.innerHeight;
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x03040a);
  scene.fog = new THREE.Fog(0x03040a, 30, 200);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  renderer.setSize(W,H);
  renderer.shadowMap.enabled = false;
  renderer.domElement.style.touchAction = 'none';
  holder.appendChild(renderer.domElement);

  const camera = new THREE.PerspectiveCamera(60, W/H, 0.1, 2000);
  camera.position.set(0, 8, 18);

  // composer + bloom (soft)
  const composer = new THREE.EffectComposer(renderer);
  composer.addPass(new THREE.RenderPass(scene, camera));
  const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(W,H), 0.6, 0.4, 0.85);
  composer.addPass(bloom);

  // lights
  const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(4,10,3); scene.add(dir);
  scene.add(new THREE.AmbientLight(0xffffff, 0.18));
  const neon = new THREE.PointLight(0x00d1ff, 1.2, 40); neon.position.set(8,4,8); scene.add(neon);
  const neon2 = new THREE.PointLight(0xff6eff, 1.2, 40); neon2.position.set(-8,4,-8); scene.add(neon2);

  // ---------- ARENA ----------
  const ARENA = 90;
  const groundMat = new THREE.MeshStandardMaterial({color:0x11121a, roughness:0.85, metalness:0.06});
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(ARENA*2, ARENA*2, 1, 1), groundMat);
  ground.rotation.x = -Math.PI/2; ground.position.y = 0; scene.add(ground);

  // arena borders (tall walls)
  const wallMat = new THREE.MeshStandardMaterial({color:0x0e0f16});
  const wallThickness = 3;
  function makeWall(x,z, w, h){
    const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, wallThickness), wallMat);
    m.position.set(x, h/2, z); scene.add(m);
  }
  makeWall(0, ARENA, ARENA*2, 18); // norte
  makeWall(0, -ARENA, ARENA*2, 18); // sur
  makeWall(ARENA, 0, wallThickness, ARENA*2); // este
  makeWall(-ARENA, 0, wallThickness, ARENA*2); // oeste

  // low-poly buildings (decor)
  function createBuilding(x,z,w,d,h){
    const geo = new THREE.BoxGeometry(w,h,d);
    const mat = new THREE.MeshStandardMaterial({color: 0x1b1d28, roughness:0.85});
    const b = new THREE.Mesh(geo, mat); b.position.set(x,h/2,z);
    scene.add(b);
    // add a few window planes (light)
    for(let i=0;i<Math.min(6,Math.floor(w));i++){
      if(Math.random()>0.6) continue;
      const win = new THREE.Mesh(new THREE.PlaneGeometry(0.4,0.4), new THREE.MeshBasicMaterial({color:0x00ffff,emissive:0x00ffff,emissiveIntensity:Math.random()*0.7+0.6}));
      win.position.set(x + (Math.random()-0.5)*w*0.6, h*0.4 + (Math.random()-0.5)*h*0.6, z + d/2 + 0.01);
      scene.add(win);
    }
    return b;
  }
  // scatter some
  for(let i=0;i<16;i++){
    const x = (Math.random()*2-1) * (ARENA-18);
    const z = (Math.random()*2-1) * (ARENA-18);
    createBuilding(x, z, 6+Math.random()*12, 6+Math.random()*12, 8+Math.random()*14);
  }

  // ---------- VEHICLE FACTORY ----------
  function makeCar(color=0xff4444, width=2.6, length=4.6){
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(width, 0.8, length), new THREE.MeshStandardMaterial({color: color, metalness:0.6, roughness:0.18}));
    body.position.y = 0.6; g.add(body);
    // wheels (simple)
    const wheelGeo = new THREE.CylinderGeometry(0.36,0.36,0.5,8);
    const wheelMat = new THREE.MeshStandardMaterial({color:0x0c0c0c});
    for(let i=0;i<4;i++){
      const w = new THREE.Mesh(wheelGeo, wheelMat);
      w.rotation.z = Math.PI/2;
      w.position.y = 0.25;
      w.position.x = (i%2===0)? -width/2 + 0.3 : width/2 - 0.3;
      w.position.z = (i<2)? length/2 - 0.6 : -length/2 + 0.6;
      g.add(w);
    }
    // small neon back
    const neon = new THREE.PointLight(0xff66dd, 1.2, 6); neon.position.set(0,0.6, length/2 + 0.6); g.add(neon); g.userData.neon = neon;
    // metadata
    g.userData = {health:100, maxHealth:100, ammo:15, maxAmmo:15, maxSpeed:1.4, rotSpeed: 0.055};
    return g;
  }

  // Player car
  const player = makeCar(0xff4444);
  player.position.set(0,0,6); scene.add(player);

  // AI cars
  const aiCars = [];
  for(let i=0;i<2;i++){
    const c = makeCar(i===0?0x55aaff:0x55ff88);
    c.position.set((i+1)*8*(i%2? -1:1),0, -8 + i*6);
    scene.add(c); aiCars.push(c);
  }

  // ---------- BULLET POOL ----------
  const bulletPool = [];
  function getBullet(){
    for(const b of bulletPool) if(!b.visible) return b;
    if(bulletPool.length < 30){
      const b = new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8), new THREE.MeshStandardMaterial({emissive:0xffcc66, color:0x222222}));
      b.visible = false; b.userData = {dir: new THREE.Vector3(), speed: 3.2, dmg:12};
      scene.add(b); bulletPool.push(b); return b;
    }
    return null;
  }
  function spawnBullet(pos, dir){
    const b = getBullet(); if(!b) return;
    b.position.copy(pos); b.visible = true; b.userData.dir.copy(dir);
  }

  // ---------- INPUT / JOYSTICK ----------
  const joy = document.getElementById('joy'), stickEl = document.getElementById('stick');
  let baseX=0, baseY=0, touchId=null, md=false;
  let stick = {x:0,y:0};
  function resetStick(){ stick={x:0,y:0}; stickEl.style.transform='translate(0px,0px)'; }

  joy.addEventListener('touchstart', e=>{ e.preventDefault(); const t = e.changedTouches[0]; touchId=t.identifier; baseX=t.clientX; baseY=t.clientY; }, {passive:false});
  joy.addEventListener('touchmove', e=>{ e.preventDefault(); for(const t of e.changedTouches){ if(t.identifier===touchId){ const dx=t.clientX-baseX, dy=t.clientY-baseY; const max=38; const nx=Math.max(-1,Math.min(1,dx/max)); const ny=Math.max(-1,Math.min(1,dy/max)); stick.x=nx; stick.y=-ny; stickEl.style.transform=`translate(${nx*28}px,${-ny*28}px)`; } } }, {passive:false});
  joy.addEventListener('touchend', e=>{ for(const t of e.changedTouches) if(t.identifier===touchId){ touchId=null; resetStick(); } }, {passive:false});

  joy.addEventListener('pointerdown', e=>{ md=true; baseX=e.clientX; baseY=e.clientY; joy.setPointerCapture(e.pointerId); });
  joy.addEventListener('pointermove', e=>{ if(!md) return; const dx=e.clientX-baseX, dy=e.clientY-baseY; const max=38; const nx=Math.max(-1,Math.min(1,dx/max)); const ny=Math.max(-1,Math.min(1,dy/max)); stick.x=nx; stick.y=-ny; stickEl.style.transform=`translate(${nx*28}px,${-ny*28}px)`; });
  joy.addEventListener('pointerup', e=>{ md=false; resetStick(); });

  // fire button
  const fireBtn = document.getElementById('fire');
  let lastFire = 0, FIRE_COOLDOWN = 380;
  fireBtn.addEventListener('touchstart', e=>{ e.preventDefault(); doFire(); }, {passive:false});
  fireBtn.addEventListener('mousedown', doFire);

  function doFire(){
    const now = performance.now();
    if(now - lastFire < FIRE_COOLDOWN || player.userData.ammo <= 0) return;
    lastFire = now; player.userData.ammo--;
    fireBtn.classList.add('cool'); setTimeout(()=>fireBtn.classList.remove('cool'), 220);
    const dir = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion).normalize();
    const origin = player.position.clone().add(new THREE.Vector3(0,0.6,-2).applyQuaternion(player.quaternion));
    spawnBullet(origin, dir);
  }

  // turbo
  const turboBtn = document.getElementById('turbo'); let turbo=false;
  turboBtn.addEventListener('touchstart', e=>{ e.preventDefault(); turbo=true; }, {passive:false});
  turboBtn.addEventListener('touchend', e=>{ e.preventDefault(); turbo=false; }, {passive:false});

  // ---------- HUD elements ----------
  const healthBar = document.getElementById('healthBar');
  const ammoBar = document.getElementById('ammoBar');
  const speedVal = document.getElementById('speedVal');
  const fpsEl = document.getElementById('fps');
  const loadingEl = document.getElementById('loading');

  // ---------- GAME STATE ----------
  let state = {speed:0, forward:0, turn:0};
  player.userData.health = 120; player.userData.maxHealth = 120; player.userData.ammo = 20; player.userData.maxAmmo = 20;
  player.userData.maxSpeed = 1.4; player.userData.rotSpeed = 0.055;

  // place player at center
  player.position.set(0,0,6);

  // ---------- INITIALIZATION DELAY (remove loading) ----------
  setTimeout(()=>{ loadingEl.style.display='none'; }, 700);

  // ---------- UTILS ----------
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

  // ---------- SIMPLE AI behavior ----------
  function updateAI(dt){
    for(const ai of aiCars){
      // rotate slowly towards center
      const target = player.position.clone();
      const dirTo = target.clone().sub(ai.position).normalize();
      const forward = new THREE.Vector3(0,0,-1).applyQuaternion(ai.quaternion).normalize();
      const angle = forward.angleTo(dirTo);
      const cross = new THREE.Vector3().crossVectors(forward, dirTo);
      let turn = 0;
      if(angle > 0.02) turn = (cross.y < 0) ? -1 : 1;
      ai.rotation.y += turn * 0.02 * dt;
      // move forward constant
      const fwdV = new THREE.Vector3(0,0,-1).applyQuaternion(ai.quaternion);
      ai.position.add(fwdV.multiplyScalar(0.6 * dt));
      // keep inside arena
      ai.position.x = clamp(ai.position.x, -ARENA+4, ARENA-4);
      ai.position.z = clamp(ai.position.z, -ARENA+4, ARENA-4);
    }
  }

  // ---------- COLLISIONS / CONSTRAINTS ----------
  function checkCollisions(dt){
    // update bullets
    for(const b of bulletPool){
      if(!b.visible) continue;
      b.position.add(b.userData.dir.clone().multiplyScalar(b.userData.speed * dt));
      // vs ai cars
      for(const ai of aiCars){
        if(ai.position.distanceTo(b.position) < 2.2){
          ai.userData.health = (ai.userData.health||100) - b.userData.dmg;
          b.visible = false;
        }
      }
      // vs player (friendly fire disabled in demo)
      if(b.position.length() > ARENA*2) b.visible = false;
    }

    // player vs walls
    player.position.x = clamp(player.position.x, -ARENA+3, ARENA-3);
    player.position.z = clamp(player.position.z, -ARENA+3, ARENA-3);

    // player vs powerups/buildings (not heavy)
    // simulate damage if colliding with building boxes: basic bounding
    // (omitted heavy checks for perf)
  }

  // ---------- MAIN LOOP ----------
  let last = performance.now(), frames=0, fpsNow=0, fpsLast = performance.now();
  function animate(){
    const now = performance.now();
    const dt = Math.min(50, now - last) / 16.666;
    last = now;

    // input -> state
    state.forward = clamp(stick.y, -1, 1);
    state.turn = clamp(stick.x, -1, 1);

    // speed update
    const accel = 0.018;
    if(state.forward > 0.05) state.speed += accel * state.forward * dt;
    else if(state.forward < -0.05) state.speed -= accel * (-state.forward) * dt;
    else state.speed *= 0.96;

    // turbo effect
    let maxSpeed = player.userData.maxSpeed * (turbo ? 1.7 : 1.0);
    state.speed = clamp(state.speed, -maxSpeed*0.6, maxSpeed);

    // rotation and movement
    player.rotation.y += -state.turn * player.userData.rotSpeed * (0.9 + Math.abs(state.speed)) * dt;
    const forwardVec = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
    player.position.add(forwardVec.multiplyScalar(state.speed * dt * 0.82));

    // bulbs/neon intensity
    player.userData.neon.intensity = turbo ? 6 : 1.5;

    // AI
    updateAI(dt);

    // bullets and collisions
    checkCollisions(dt);

    // camera smooth follow
    const desiredCam = player.position.clone().add(new THREE.Vector3(0,6,14).applyQuaternion(player.quaternion));
    camera.position.lerp(desiredCam, 0.12);
    camera.lookAt(player.position.clone().add(new THREE.Vector3(0,1.4,0)));

    // HUD
    healthBar.style.width = (player.userData.health / player.userData.maxHealth * 100) + '%';
    ammoBar.style.width = (player.userData.ammo / player.userData.maxAmmo * 100) + '%';
    speedVal.textContent = Math.round(Math.abs(state.speed) / player.userData.maxSpeed * 200);

    // bullets visibility update (simple)
    for(const b of bulletPool){
      if(b.visible){
        // optional glow scale
        b.material.emissiveIntensity = 1.8;
      }
    }

    // render
    composer.render();

    // fps calc
    frames++; if(now - fpsLast >= 500){ fpsNow = Math.round((frames*1000)/(now-fpsLast)); frames=0; fpsLast = now; fpsEl.textContent = 'FPS: ' + fpsNow; }

    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  // ---------- spawn management for bullets pool visually (pre-warm) ----------
  for(let i=0;i<10;i++) getBullet();

  // adjust on resize
  window.addEventListener('resize', ()=> {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
    composer.setSize(window.innerWidth, window.innerHeight);
  });

  // developer helpers: allow keyboard for desktop testing
  window.addEventListener('keydown', e=>{
    if(e.key === 'w') stick.y = 1;
    if(e.key === 's') stick.y = -1;
    if(e.key === 'a') stick.x = -1;
    if(e.key === 'd') stick.x = 1;
    if(e.key === ' ') doFire();
    if(e.key === 'Shift') turbo = true;
  });
  window.addEventListener('keyup', e=>{
    if(['w','s'].includes(e.key)) stick.y = 0;
    if(['a','d'].includes(e.key)) stick.x = 0;
    if(e.key === 'Shift') turbo = false;
  });

})();
</script>
</body>
</html>
