<!-- index.html - SinFiltro: Veh√≠culos 3D con calles reales (Jardines de Morelos) -->
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SinFiltro - Arena Vehicular (MVP con Mapa Real)</title>
<style>
  html,body{height:100%;margin:0;background:#05060a;color:#eaf7ff;font-family:Inter,system-ui;overflow:hidden}
  #overlayUI{position:fixed;inset:0;pointer-events:none}
  #canvasHolder{width:100%;height:100%}
  .joy{position:fixed;left:18px;bottom:18px;width:110px;height:110px;border-radius:60px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;pointer-events:auto;z-index:30}
  .stick{width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,0.08);transform:translate(0,0)}
  .btnFire{position:fixed;right:20px;bottom:34px;width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#00d1ff,#8a6eff);color:#001;font-weight:700;font-size:28px;display:flex;align-items:center;justify-content:center;pointer-events:auto;z-index:30;box-shadow:0 12px 40px rgba(0,0,0,0.5)}
  .topBar{position:fixed;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;align-items:center;pointer-events:auto;z-index:40}
  .logo{font-weight:700;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .miniBtns{display:flex;gap:8px}
  .icon{padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)}
  #viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:50}
  #viewer img{max-width:90%;height:auto;border-radius:12px}
  @media(max-width:420px){.joy{width:96px;height:96px}.stick{width:42px;height:42px}.btnFire{width:64px;height:64px}}
</style>
</head>
<body>
  <div id="canvasHolder"></div>

  <!-- UI -->
  <div id="overlayUI">
    <div class="topBar">
      <div class="logo">SinFiltro - Arena</div>
      <div class="miniBtns">
        <div class="icon" id="btnMenu">‚ò∞</div>
        <div class="icon" id="btnStart">‚ñ∂</div>
      </div>
    </div>

    <div class="joy" id="joy">
      <div class="stick" id="stick"></div>
    </div>

    <div class="btnFire" id="btnFire">üî´</div>
  </div>

  <div id="viewer" role="dialog" aria-hidden="true">
    <div style="text-align:center">
      <img id="viewerImg" src="" alt="preview"><br><br>
      <button id="closeViewer" style="padding:8px 12px;border-radius:8px">Cerrar</button>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script>
  (function(){
    const holder = document.getElementById('canvasHolder');
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x05060a, 0.002);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    holder.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(0,6,10);

    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(5,10,7); scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff, 0.25));

    const gmat = new THREE.MeshStandardMaterial({color:0x0b1220, metalness:0.1, roughness:0.9});
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(2000,2000), gmat);
    ground.rotation.x = -Math.PI/2; scene.add(ground);

    // VEH√çCULO DEL JUGADOR
    const car = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.7,4.2), new THREE.MeshStandardMaterial({color:0xff5555}));
    body.position.y = 0.7; car.add(body);
    const wheelGeo = new THREE.CylinderGeometry(0.35,0.35,0.5,8);
    const wheelMat = new THREE.MeshStandardMaterial({color:0x111111});
    for(let i=0;i<4;i++){
      const w = new THREE.Mesh(wheelGeo, wheelMat);
      w.rotation.z = Math.PI/2; w.position.y = 0.25;
      w.position.x = (i%2===0)?-1:1; w.position.z = (i<2)?1.2:-1.2; car.add(w);
    }
    scene.add(car);

    // ENEMIGO DEMO
    const bot = car.clone();
    bot.children[0].material = new THREE.MeshStandardMaterial({color:0x55aaff});
    bot.position.set(8,0,-6); scene.add(bot);

    const state = {forward:0, turn:0, speed:0, maxSpeed:0.8, rotSpeed:0.04};
    const camOffset = new THREE.Vector3(0,4,10);
    let lastTime = performance.now();
    const bullets = [];

    function spawnBullet(origin, dir){
      const g = new THREE.SphereGeometry(0.12,8,8);
      const m = new THREE.MeshStandardMaterial({emissive:0xffcc77});
      const b = new THREE.Mesh(g,m);
      b.position.copy(origin); b.userData.dir = dir.clone(); b.userData.speed = 2.2;
      scene.add(b); bullets.push(b);
    }

    // JOYSTICK
    const joy = document.getElementById('joy'), stickEl = document.getElementById('stick');
    let stick={x:0,y:0}, touchId=null, baseX=0, baseY=0;
    function resetStick(){ stick={x:0,y:0}; stickEl.style.transform=`translate(0,0)`; }
    joy.addEventListener('touchstart',e=>{const t=e.changedTouches[0];touchId=t.identifier;baseX=t.clientX;baseY=t.clientY;},{passive:true});
    joy.addEventListener('touchmove',e=>{
      for(const t of e.changedTouches){if(t.identifier===touchId){
        const dx=t.clientX-baseX, dy=t.clientY-baseY, max=36;
        stick.x=Math.max(-1,Math.min(1,dx/max)); stick.y=Math.max(-1,Math.min(1,-dy/max));
        stickEl.style.transform=`translate(${stick.x*28}px,${-stick.y*28}px)`;
      }}},{passive:true});
    joy.addEventListener('touchend',()=>{resetStick();},{passive:true});

    document.getElementById('btnFire').addEventListener('click',()=>{
      const dir = new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion);
      const origin = car.position.clone().add(new THREE.Vector3(0,1,-2).applyQuaternion(car.quaternion));
      spawnBullet(origin, dir);
    });

    // LOOP PRINCIPAL
    function animate(){
      const now=performance.now(), dt=Math.min(50,now-lastTime)/16.666; lastTime=now;
      state.forward=stick.y; state.turn=stick.x;
      if(state.forward>0.05) state.speed+=0.02*state.forward*dt;
      else if(state.forward<-0.05) state.speed-=0.03*(-state.forward)*dt;
      else state.speed*=0.98;
      state.speed=Math.max(-state.maxSpeed,Math.min(state.maxSpeed,state.speed));
      car.rotation.y += -state.turn*state.rotSpeed*(0.9+Math.abs(state.speed))*dt;
      const forward=new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion);
      car.position.add(forward.multiplyScalar(state.speed*dt*0.8));
      const camTarget=car.position.clone().add(new THREE.Vector3(0,4,10).applyQuaternion(car.quaternion));
      camera.position.lerp(camTarget,0.12); camera.lookAt(car.position.clone().add(new THREE.Vector3(0,1.5,0)));

      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    animate();

    // MAPA REAL: CALLES DE JARDINES DE MORELOS
    (async function loadOSM(){
      const NOMINATIM_QUERY='Jardines de Morelos, Ecatepec de Morelos, M√©xico';
      const OVERPASS_URL='https://overpass-api.de/api/interpreter';
      function lonLatToMeters(lon,lat,refLat){
        const latMeters=lat*111320;
        const lonMeters=lon*(111320*Math.cos(refLat*Math.PI/180));
        return [lonMeters,latMeters];
      }
      try{
        const nomData=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(NOMINATIM_QUERY)}&limit=1`);
        const nom=await nomData.json(); if(!nom.length) return;
        const [south,north,west,east]=nom[0].boundingbox.map(parseFloat);
        const q=`[out:json][timeout:25];(way["highway"](${south},${west},${north},${east}););(._;>;);out body;`;
        const res=await fetch(OVERPASS_URL,{method:'POST',body:q,headers:{'Content-Type':'text/plain'}});
        const json=await res.json();
        const nodes=new Map(); const ways=[];
        for(const el of json.elements){if(el.type==='node')nodes.set(el.id,[el.lon,el.lat]);}
        for(const el of json.elements){if(el.type==='way'){const pts=(el.nodes||[]).map(id=>nodes.get(id)).filter(Boolean);if(pts.length>1)ways.push(pts);}}
        const refLat=(north+south)/2, centerLon=(west+east)/2, centerLat=(north+south)/2;
        const [cx,cy]=lonLatToMeters(centerLon,centerLat,refLat);
        const roads=new THREE.Group();
        const mat=new THREE.LineBasicMaterial({color:0x33aaff,transparent:true,opacity:0.9});
        for(const pts of ways){
          const pos=new Float32Array(pts.length*3);
          pts.forEach((p,i)=>{
            const [mx,my]=lonLatToMeters(p[0],p[1],refLat);
            pos[i*3]=mx-cx; pos[i*3+1]=0.02; pos[i*3+2]=-(my-cy);
          });
          const geo=new THREE.BufferGeometry(); geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
          const line=new THREE.Line(geo,mat); roads.add(line);
        }
        roads.scale.set(0.6,0.6,0.6);
        scene.add(roads);
        console.log('Calles cargadas:',ways.length);
      }catch(e){console.error(e);}
    })();

    window.addEventListener('resize',()=>{
      renderer.setSize(window.innerWidth,window.innerHeight);
      camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
    });

    // UI
    document.getElementById('btnMenu').addEventListener('click',()=>alert('Men√∫ en desarrollo'));
    document.getElementById('btnStart').addEventListener('click',()=>alert('Iniciando partida...'));
    const viewer=document.getElementById('viewer');
    document.querySelector('.logo').addEventListener('click',()=>{viewer.style.display='flex';});
    document.getElementById('closeViewer').addEventListener('click',()=>viewer.style.display='none');
  })();
  </script>
</body>
</html>
