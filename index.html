<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SinFiltro ‚Äî Plataforma (Demo completo)</title>

<!-- Meta / Open Graph -->
<meta name="description" content="SinFiltro ‚Äî comparte fotos, videos y conecta. Versi√≥n demo con monetizaci√≥n simulada, PWA-ready y panel de control.">
<meta property="og:title" content="SinFiltro ‚Äî Tu espacio sin l√≠mites">
<meta property="og:description" content="Fotos y videos creados por la comunidad. Da like, comenta y comparte.">
<meta property="og:image" content="https://booss-new.github.io/sinfiltro/og-image.png">
<meta property="og:url" content="https://booss-new.github.io/sinfiltro/">
<meta name="twitter:card" content="summary_large_image">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- Basic styles: m√≥vil-first, limpio y elegante (YouTube + Instagram mix) -->
<style>
:root{
  --bg-1:#05060a; --bg-2:#0b1220;
  --accent-1:#00d1ff; --accent-2:#8a6eff; --accent-3:#ff5fb7;
  --muted:#9fb0bf; --card:#071226; --radius:12px; --trans:220ms;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Inter',system-ui,Arial,sans-serif;background:
  radial-gradient(600px 300px at 10% 10%, rgba(0,200,255,0.03), transparent 8%),
  linear-gradient(180deg,var(--bg-1),var(--bg-2) 70%);color:#eaf7ff;-webkit-font-smoothing:antialiased;overflow:hidden}
a{color:inherit}
button{font:inherit}

/* App layout */
.app{height:100vh;display:flex;flex-direction:column;overflow:hidden}
.scroll{overflow-y:auto;padding-bottom:150px;-webkit-overflow-scrolling:touch}

/* Header */
header{position:sticky;top:0;z-index:60;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.02)}
.brand{display:flex;flex-direction:column;align-items:center;gap:2px}
.brand .title{color:var(--accent-1);font-weight:700}
.icon-btn{width:44px;height:44px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;color:var(--muted);border:1px solid rgba(255,255,255,0.02);cursor:pointer}

/* Search overlay */
.search-overlay{position:fixed;left:12px;right:12px;top:64px;z-index:65;display:none}
.search-input{width:100%;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:#eaf7ff}

/* Hero */
.hero{margin:12px;padding:14px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.hero h1{margin:0;color:var(--accent-2);font-size:18px}
.hero p{margin-top:6px;color:var(--muted);font-size:13px}

/* Sections */
.section{margin-top:16px;padding:0 12px}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.section-title{font-weight:700;color:var(--accent-1)}
.see-all{font-size:13px;color:var(--muted);cursor:pointer}

/* Horizontal row */
.h-row{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;padding-top:6px}
.h-row::-webkit-scrollbar{display:none}
.thumb-card{flex:0 0 170px;border-radius:12px;overflow:hidden;background:var(--card);border:1px solid rgba(255,255,255,0.02);transition:transform var(--trans)}
.thumb-card:hover{transform:translateY(-6px)}
.thumb{width:170px;height:100px;object-fit:cover;display:block}
.thumb-info{padding:8px;color:#eaf7ff;font-weight:600;font-size:13px}

/* Feed grid (2 columns mobile) */
.feed{padding:14px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.feed-item{border-radius:12px;overflow:hidden;background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);box-shadow:0 10px 40px rgba(0,0,0,0.6);transition:transform var(--trans)}
.feed-item:hover{transform:translateY(-6px)}
.feed-item img{width:100%;height:150px;object-fit:cover;display:block}
.feed-body{padding:10px}
.feed-title{font-weight:700;color:#eaf7ff;font-size:13px}
.feed-meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:var(--muted);font-size:12px}

/* Floating FAB */
.fab-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:34px;z-index:80}
.fab{width:66px;height:66px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#001;border:none;box-shadow:0 30px 80px rgba(0,200,255,0.12);font-size:28px;cursor:pointer}

/* Bottom nav */
.bottom-nav{position:fixed;left:10px;right:10px;bottom:8px;height:72px;border-radius:18px;background:linear-gradient(180deg,rgba(2,8,16,0.9),rgba(4,12,22,0.85));display:flex;align-items:center;justify-content:space-around;padding:0 10px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 20px 50px rgba(0,0,0,0.6);z-index:70}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);font-size:12px;cursor:pointer}
.nav-item.active{color:var(--accent-1);transform:translateY(-3px)}

/* Viewer & drawer */
.viewer{position:fixed;left:0;right:0;top:0;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0.96),rgba(0,0,0,0.96));display:flex;align-items:center;justify-content:center;z-index:120;padding:18px;gap:12px;flex-direction:column;display:none}
.viewer.show{display:flex}
.viewer .content{width:100%;max-width:920px;border-radius:12px;overflow:hidden;background:#000}
.drawer{position:fixed;left:0;right:0;bottom:0;height:56%;background:linear-gradient(180deg,#071226,#041224);border-top-left-radius:18px;border-top-right-radius:18px;padding:12px;z-index:130;display:none;flex-direction:column}
.drawer.show{display:flex}
.drawer .handle{width:48px;height:6px;background:rgba(255,255,255,0.06);border-radius:20px;margin:6px auto}
.comments{overflow:auto;margin-top:8px;flex:1;padding-right:6px}
.comment{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
.comment strong{display:block;color:#e7fbff}

/* Upload modal */
.upload-modal{position:fixed;left:12px;right:12px;bottom:120px;border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);box-shadow:0 18px 40px rgba(0,0,0,0.7);z-index:110;display:none}
.upload-modal.show{display:block}

/* Dashboard modal (monetization) */
.dashboard{position:fixed;left:12px;right:12px;top:12px;bottom:12px;border-radius:12px;padding:12px;background:linear-gradient(180deg,#001018,#001424);border:1px solid rgba(255,255,255,0.02);box-shadow:0 30px 80px rgba(0,0,0,0.8);z-index:200;display:none;overflow:auto}
.dashboard.show{display:block}
.kpi{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.kpi .card{flex:1;min-width:140px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}

/* responsive */
@media(max-width:420px){
  .thumb{width:150px;height:88px}
  .feed-item img{height:120px}
  .fab{width:60px;height:60px}
}
</style>
</head>
<body>
<!-- App root -->
<div class="app" role="application" aria-label="SinFiltro">

  <!-- Header -->
  <header>
    <div class="left">
      <div class="icon-btn" id="menuBtn" title="Panel">‚ò∞</div>
    </div>

    <div class="brand" aria-hidden="false">
      <div class="title">SinFiltro</div>
      <div class="subtitle">Tu espacio sin l√≠mites</div>
    </div>

    <div class="right">
      <div class="icon-btn" id="searchBtn" title="Buscar">üîé</div>
    </div>
  </header>

  <!-- Search overlay -->
  <div class="search-overlay" id="searchOverlay">
    <input id="searchInput" class="search-input" placeholder="Buscar videos, im√°genes o usuarios..." aria-label="Buscar">
  </div>

  <!-- Scrollable content -->
  <div class="scroll" id="scrollArea" tabindex="0">
    <main>
      <section class="hero" aria-label="Presentaci√≥n">
        <h1>Descubre lo aut√©ntico</h1>
        <p>Fotos y videos creados por la comunidad. Da like, comenta y comparte.</p>
      </section>

      <!-- Trending -->
      <section class="section">
        <div class="section-header">
          <div class="section-title">üî• En Tendencia</div>
          <div class="see-all" id="seeTrending">Ver todo</div>
        </div>
        <div class="h-row" id="trendingRow" aria-live="polite"></div>
      </section>

      <!-- Recent -->
      <section class="section">
        <div class="section-header">
          <div class="section-title">‚èÆÔ∏è Vistos recientemente</div>
          <div class="see-all" id="seeRecent">Ver todo</div>
        </div>
        <div class="h-row" id="recentRow"></div>
      </section>

      <!-- Feed -->
      <section class="section">
        <div class="section-header">
          <div class="section-title">üéØ Recomendados</div>
          <div class="see-all" id="seeReco">Ver todo</div>
        </div>
        <div class="feed" id="feedGrid"></div>
      </section>
    </main>
  </div>

  <!-- FAB -->
  <div class="fab-wrap" aria-hidden="false">
    <button class="fab" id="fabBtn" aria-label="Crear / Subir">Ôºã</button>
  </div>

  <!-- Upload modal -->
  <div class="upload-modal" id="uploadModal" role="dialog" aria-modal="true" aria-hidden="true">
    <strong>Subir contenido (demo)</strong>
    <div style="color:var(--muted);font-size:13px;margin-top:8px">Selecciona imagen o video. Se guarda localmente en este navegador (demo).</div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input type="file" id="fileInput" accept="image/*,video/*">
      <button id="uploadBtn" style="background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:none;padding:8px 12px;border-radius:10px;color:#001;font-weight:700">Subir</button>
    </div>
    <div style="margin-top:10px;font-size:13px;color:var(--muted)">Opciones de monetizaci√≥n demo disponibles en el panel.</div>
  </div>

  <!-- Viewer -->
  <div class="viewer" id="viewer" role="dialog" aria-hidden="true">
    <div class="content" id="viewerContent"></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="openCommentsBtn" style="background:none;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted)">üí¨ Comentarios</button>
      <button id="closeViewer" style="background:none;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted)">Cerrar</button>
    </div>
  </div>

  <!-- Comments drawer -->
  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="handle" aria-hidden="true"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong id="drawerTitle">Comentarios</strong>
      <button id="closeDrawer" style="background:none;border:none;color:var(--muted)">Cerrar</button>
    </div>
    <div class="comments" id="commentsList" role="log" aria-live="polite"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="commentInput" placeholder="Escribe un comentario..." style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf7ff" />
      <button id="postComment" style="background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:none;padding:10px;border-radius:10px;color:#001;font-weight:700">Enviar</button>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav" role="navigation" aria-label="Navegaci√≥n principal">
    <div class="nav-item active" data-tab="home" id="navHome">üè†<div style="font-size:11px">Inicio</div></div>
    <div class="nav-item" data-tab="explore" id="navExplore">üîé<div style="font-size:11px">Explorar</div></div>
    <div style="width:68px"></div>
    <div class="nav-item" data-tab="likes" id="navLikes">‚ù§<div style="font-size:11px">Me gusta</div></div>
    <div class="nav-item" data-tab="profile" id="navProfile">üë§<div style="font-size:11px">Perfil</div></div>
  </nav>
</div>

<!-- Dashboard (monetization + analytics) -->
<div class="dashboard" id="dashboard" role="dialog" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <strong>Dashboard ‚Äî Monetizaci√≥n & Analytics (Demo)</strong>
    <div>
      <button id="closeDashboard" style="margin-right:8px;padding:6px 10px;border-radius:8px;background:none;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">Cerrar</button>
      <button id="exportCsv" style="padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:none;color:#001">Exportar CSV</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi">
    <div class="card">
      <div style="font-size:12px;color:var(--muted)">Impresiones anuncios</div>
      <div id="kpiImpressions" style="font-weight:700;font-size:18px">0</div>
    </div>
    <div class="card">
      <div style="font-size:12px;color:var(--muted)">Clicks (acortador)</div>
      <div id="kpiShortClicks" style="font-weight:700;font-size:18px">0</div>
    </div>
    <div class="card">
      <div style="font-size:12px;color:var(--muted)">Suscripciones Activas</div>
      <div id="kpiSubs" style="font-weight:700;font-size:18px">0</div>
    </div>
    <div class="card">
      <div style="font-size:12px;color:var(--muted)">Ventas mercado</div>
      <div id="kpiSales" style="font-weight:700;font-size:18px">0</div>
    </div>
    <div class="card">
      <div style="font-size:12px;color:var(--muted)">Ganancias Estimadas (USD)</div>
      <div id="kpiRevenue" style="font-weight:700;font-size:18px">$0.00</div>
    </div>
  </div>

  <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
  <div style="display:flex;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:220px">
      <h4 style="margin:0 0 8px 0">Simular eventos</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="simImp" style="padding:8px;border-radius:8px;background:#123;padding:8px 10px;color:#fff">+ Impresi√≥n</button>
        <button id="simShort" style="padding:8px;border-radius:8px;background:#123">+ Click acortador</button>
        <button id="simSub" style="padding:8px;border-radius:8px;background:#123">+ Suscripci√≥n</button>
        <button id="simSale" style="padding:8px;border-radius:8px;background:#123">+ Venta</button>
        <button id="resetStats" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">Reset</button>
      </div>
      <p style="color:var(--muted);font-size:13px;margin-top:10px">En producci√≥n, estos eventos se actualizan autom√°ticamente (Ad network callbacks, shortener webhooks, Stripe webhooks, etc.). Aqu√≠ se simulan localmente.</p>
    </div>

    <div style="flex:1;min-width:220px">
      <h4 style="margin:0 0 8px 0">Conexiones reales (placeholders)</h4>
      <p style="color:var(--muted);font-size:13px;margin-top:0">Para activar pagos reales pega tus keys/IDs donde se indica en el c√≥digo JS:</p>
      <ul style="color:var(--muted);font-size:13px">
        <li>AdSense / Ad network ‚Äî insertar script en &lt;head&gt; (ID en variable <code>AD_NETWORK_ID</code>).</li>
        <li>ShrinkMe / Shortener ‚Äî API key para acortar enlaces (variable <code>SHORTENER_API_KEY</code>).</li>
        <li>Stripe / PayPal ‚Äî credenciales para cobros y webhooks (placeholders en la funci√≥n <code>startSubscription()</code>).</li>
      </ul>
    </div>
  </div>

</div>

<!-- Scripts: app logic, monetization simulation, lazy-loading, PWA register guidance -->
<script>
/* -----------------------------
   Storage keys & initial demo
   ----------------------------- */
const STORAGE_FEED = 'sinfiltro.feed.v4';
const STORAGE_COMMENTS = 'sinfiltro.comments.v4';
const STORAGE_LIKES = 'sinfiltro.likes.v4';
const STORAGE_STATS = 'sinfiltro.stats.v4';

/* Monetization config (change these to real values when ready) */
const AD_NETWORK_ID = '';        // <- Insert AdSense / Ad Network ID here
const SHORTENER_API_KEY = '';    // <- Insert shortener API key here (e.g. ShrinkMe)
const STRIPE_PUBLISHABLE_KEY = ''; // <- Insert Stripe publishable key if using Stripe Checkout
const PAYPAL_LINK = '';          // <- PayPal.me or PayPal Checkout link

/* Pricing / rates used in simulation (editable) */
const SIM = {
  cpm_usd: 2.0,          // $ per 1000 ad impressions
  short_click_usd: 0.02, // $ per shortener valid click
  subscription_usd_month: 3.0,
  marketplace_fee_percent: 10, // platform commission
};

/* Initial feed demo */
const DEMO_FEED = [
  {id:'p1',type:'image',src:'https://picsum.photos/640/420?random=41',title:'Atardecer urbano',meta:'12K ‚Ä¢ 2 d√≠as',likes:124},
  {id:'p2',type:'image',src:'https://picsum.photos/640/420?random=42',title:'Retrato creativo',meta:'8.2K ‚Ä¢ 1 d√≠a',likes:98},
  {id:'p3',type:'image',src:'https://picsum.photos/640/420?random=43',title:'Luces en la ciudad',meta:'6.4K ‚Ä¢ 5 d√≠as',likes:45},
  {id:'p4',type:'image',src:'https://picsum.photos/640/420?random=44',title:'Callej√≥n neon',meta:'210K ‚Ä¢ 1 semana',likes:340},
  {id:'p5',type:'image',src:'https://picsum.photos/640/420?random=45',title:'Short creativo',meta:'3.4K ‚Ä¢ 2 semanas',likes:72},
  {id:'p6',type:'image',src:'https://picsum.photos/640/420?random=46',title:'Nocturna',meta:'18K ‚Ä¢ 4 d√≠as',likes:180}
];

function load(key, fallback){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):fallback }catch(e){ return fallback } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }

/* Stats structure for monetization tracking (local demo) */
let stats = load(STORAGE_STATS, {
  adImpressions: 0,
  shortClicks: 0,
  subscriptions: 0,
  marketplaceSales: 0,
  donations: 0.0
});

/* Feed, comments, likes */
let feed = load(STORAGE_FEED, DEMO_FEED.slice());
let comments = load(STORAGE_COMMENTS, {});
let likes = load(STORAGE_LIKES, {});

/* -----------------------------
   DOM refs
   ----------------------------- */
const trendingRow = document.getElementById('trendingRow');
const recentRow = document.getElementById('recentRow');
const feedGrid = document.getElementById('feedGrid');

const viewer = document.getElementById('viewer');
const viewerContent = document.getElementById('viewerContent');
const drawer = document.getElementById('drawer');
const commentsList = document.getElementById('commentsList');

const uploadModal = document.getElementById('uploadModal');
const fileInput = document.getElementById('fileInput');

const dashboardEl = document.getElementById('dashboard');

/* -----------------------------
   Render functions (UI)
   ----------------------------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function createThumb(item){
  const el = document.createElement('div');
  el.className = 'thumb-card';
  el.innerHTML = `<img class="thumb" data-src="${item.src}" alt="${escapeHtml(item.title)}"><div class="thumb-info">${escapeHtml(item.title)}<div style="font-size:12px;color:var(--muted);margin-top:6px">${escapeHtml(item.meta)}</div></div>`;
  el.addEventListener('click', ()=> openViewer(item.id));
  return el;
}

function renderRows(){
  trendingRow.innerHTML=''; recentRow.innerHTML='';
  const trend = [...feed].sort((a,b)=> (b.likes||0)-(a.likes||0)).slice(0,8);
  trend.forEach(i=> trendingRow.appendChild(createThumb(i)));
  const recent = [...feed].slice().reverse().slice(0,8);
  recent.forEach(i=> recentRow.appendChild(createThumb(i)));
  lazyObserveImages();
}

function createFeedItem(item){
  const el = document.createElement('article');
  el.className = 'feed-item';
  el.innerHTML = `<img data-src="${item.src}" alt="${escapeHtml(item.title)}"><div class="feed-body"><div class="feed-title">${escapeHtml(item.title)}</div><div class="feed-meta"><div>${escapeHtml(item.meta)}</div><div style="display:flex;gap:8px;align-items:center"><button class="like-btn" data-id="${item.id}">‚ù§ <span class="count">${item.likes||0}</span></button><button class="comment-btn" data-id="${item.id}">üí¨ <span class="count">${(comments[item.id]||[]).length}</span></button><button class="share-btn" data-id="${item.id}">üîó</button></div></div></div>`;
  el.querySelector('.like-btn').addEventListener('click', (e)=>{ e.stopPropagation(); toggleLike(item.id); });
  el.querySelector('.comment-btn').addEventListener('click', (e)=>{ e.stopPropagation(); openComments(item.id, item.title); });
  el.querySelector('.share-btn').addEventListener('click', (e)=>{ e.stopPropagation(); shareItem(item); });
  el.addEventListener('click', ()=> openViewer(item.id));
  return el;
}

function renderFeed(){ feedGrid.innerHTML=''; feed.forEach(i=> feedGrid.appendChild(createFeedItem(i))); lazyObserveImages(); }

/* -----------------------------
   Viewer & Comments
   ----------------------------- */
let currentOpen = null;
function openViewer(id){
  const item = feed.find(f=>f.id===id); if(!item) return;
  currentOpen = id;
  viewerContent.innerHTML = '';
  if(item.type==='video'){
    const v = document.createElement('video'); v.src=item.src; v.controls=true; v.autoplay=true; v.style.maxHeight='70vh';
    viewerContent.appendChild(v);
  } else {
    const img = document.createElement('img'); img.src=item.src; img.alt=item.title; viewerContent.appendChild(img);
  }
  // Ad impression: count when user opens viewer (simulate ad loaded)
  recordAdImpression(1);
  viewer.classList.add('show');
}
document.getElementById('closeViewer').addEventListener('click', ()=> viewer.classList.remove('show'));
document.getElementById('openCommentsBtn').addEventListener('click', ()=> { viewer.classList.remove('show'); openComments(currentOpen, feed.find(f=>f.id===currentOpen).title); });

function openComments(id, title){
  currentOpen = id;
  document.getElementById('drawerTitle').textContent = `Comentarios ‚Äî ${title}`;
  commentsList.innerHTML = '';
  const arr = comments[id] || [];
  arr.forEach(c=>{
    const d = document.createElement('div'); d.className='comment';
    d.innerHTML = `<strong>Usuario</strong><div style="color:var(--muted);font-size:13px">${escapeHtml(c.text)}</div>`;
    commentsList.appendChild(d);
  });
  drawer.classList.add('show');
}
document.getElementById('closeDrawer').addEventListener('click', ()=> drawer.classList.remove('show'));
document.getElementById('postComment').addEventListener('click', ()=>{
  const txt = document.getElementById('commentInput').value.trim();
  if(!txt || !currentOpen) return;
  comments[currentOpen] = comments[currentOpen] || [];
  comments[currentOpen].push({text:txt,ts:Date.now()});
  save(STORAGE_COMMENTS, comments);
  document.getElementById('commentInput').value='';
  openComments(currentOpen, feed.find(f=>f.id===currentOpen).title);
  renderFeed();
});

/* -----------------------------
   Likes, share & shortener
   ----------------------------- */
function toggleLike(id){
  likes = load(STORAGE_LIKES, likes);
  const liked = !!likes[id];
  if(liked) delete likes[id]; else likes[id]=true;
  save(STORAGE_LIKES, likes);
  // update feed likes count (local demo)
  const idx = feed.findIndex(f=>f.id===id);
  if(idx>=0){ feed[idx].likes = feed[idx].likes || 0; feed[idx].likes = liked ? Math.max(0, feed[idx].likes-1): feed[idx].likes+1; save(STORAGE_FEED, feed); }
  renderFeed(); renderRows();
}

/* Share flow:
   - Attempt to use navigator.share (native)
   - Fallback: create short link simulation (counts towards shortClicks and revenue)
   - If you integrate a real shortener API, replace shortenLink() implementation */
async function shareItem(item){
  const shareText = `${item.title} ‚Äî V√≠a SinFiltro`;
  const urlToShare = item.src; // In production, use a canonical post URL
  if(navigator.share){
    try{ await navigator.share({title:item.title,text:shareText,url:urlToShare});}
    catch(e){}
    return;
  }
  // fallback: shorten link (simulated)
  const short = await shortenLinkSim(urlToShare);
  // open the short link in new tab
  window.open(short, '_blank');
}

/* Simulated shortener (replace with real API call when ready).
   Increments shortClicks when the shortened link is "opened".
   We simulate that each open generates revenue. */
function shortenLinkSim(url){
  // Create a fake short URL and count a click when user opens.
  const id = Math.random().toString(36).slice(2,8);
  const shortUrl = `${location.origin}/s/${id}`; // demo route (not actually resolving)
  // Simulate: register short click when user opens (we can't detect external opens reliably without backend)
  // For demo: increase shortClicks now (as if user clicked the shortener landing)
  stats.shortClicks += 1;
  save(STORAGE_STATS, stats);
  updateDashboardKPIs();
  alert('Se ha generado un enlace acortado de demostraci√≥n. (Simulaci√≥n) ‚Äî ' + shortUrl);
  return Promise.resolve(shortUrl);
}

/* -----------------------------
   Monetization events & dashboard
   ----------------------------- */
function recordAdImpression(n=1){
  stats.adImpressions += n;
  save(STORAGE_STATS, stats);
  updateDashboardKPIs();
}
function recordShortClick(n=1){
  stats.shortClicks += n;
  save(STORAGE_STATS, stats);
  updateDashboardKPIs();
}
function recordSubscription(n=1){
  stats.subscriptions += n;
  save(STORAGE_STATS, stats);
  updateDashboardKPIs();
}
function recordSale(n=1, amount=0){
  stats.marketplaceSales += n;
  stats.donations += amount; // store sale revenue under donations for demo
  save(STORAGE_STATS, stats);
  updateDashboardKPIs();
}

/* Compute estimated revenue from stats */
function computeRevenue(){
  const fromAds = (stats.adImpressions/1000) * SIM.cpm_usd;
  const fromShort = stats.shortClicks * SIM.short_click_usd;
  const fromSubs = stats.subscriptions * SIM.subscription_usd_month;
  const fromSales = stats.marketplaceSales * 5.0 * (SIM.marketplace_fee_percent/100); // assume 5$ avg sale * fee
  const total = fromAds + fromShort + fromSubs + fromSales + (stats.donations||0);
  return {fromAds,fromShort,fromSubs,fromSales,total};
}

/* Update dashboard UI */
function updateDashboardKPIs(){
  document.getElementById('kpiImpressions').textContent = stats.adImpressions.toLocaleString();
  document.getElementById('kpiShortClicks').textContent = stats.shortClicks.toLocaleString();
  document.getElementById('kpiSubs').textContent = stats.subscriptions.toLocaleString();
  document.getElementById('kpiSales').textContent = stats.marketplaceSales.toLocaleString();
  const rev = computeRevenue();
  document.getElementById('kpiRevenue').textContent = '$' + rev.total.toFixed(2);
}

/* Dashboard actions (simulate events) */
document.getElementById('simImp').addEventListener('click', ()=>{ recordAdImpression(1); });
document.getElementById('simShort').addEventListener('click', ()=>{ recordShortClick(1); });
document.getElementById('simSub').addEventListener('click', ()=>{ recordSubscription(1); alert('Simulaci√≥n: usuario suscrito (demo).'); });
document.getElementById('simSale').addEventListener('click', ()=>{ recordSale(1, 5.0); alert('Simulaci√≥n: venta procesada (demo).'); });
document.getElementById('resetStats').addEventListener('click', ()=>{ if(confirm('Resetear estad√≠sticas demo?')){ stats={adImpressions:0,shortClicks:0,subscriptions:0,marketplaceSales:0,donations:0}; save(STORAGE_STATS,stats); updateDashboardKPIs(); }});
document.getElementById('exportCsv').addEventListener('click', exportStatsCsv);

/* Open / close dashboard */
document.getElementById('menuBtn').addEventListener('click', ()=>{ dashboardEl.classList.add('show'); updateDashboardKPIs(); });
document.getElementById('closeDashboard').addEventListener('click', ()=> dashboardEl.classList.remove('show'));

/* Export CSV */
function exportStatsCsv(){
  const rev = computeRevenue();
  const rows = [
    ['Metric','Value'],
    ['Ad Impressions', stats.adImpressions],
    ['Short Clicks', stats.shortClicks],
    ['Subscriptions', stats.subscriptions],
    ['Marketplace Sales', stats.marketplaceSales],
    ['Donations', stats.donations],
    ['Estimated Revenue (USD)', rev.total.toFixed(2)]
  ];
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'sinfiltro_stats.csv'; a.click(); URL.revokeObjectURL(url);
}

/* -----------------------------
   Upload (demo local)
   ----------------------------- */
document.getElementById('fabBtn').addEventListener('click', ()=> toggleUpload());
document.getElementById('uploadBtn').addEventListener('click', doUpload);
function toggleUpload(){ uploadModal.classList.toggle('show'); fileInput.value=''; }
function doUpload(){
  const f = fileInput.files[0]; if(!f){ alert('Selecciona un archivo'); return; }
  const reader = new FileReader();
  reader.onload = (e)=>{
    const url = e.target.result;
    const newItem = {id: crypto.randomUUID(), type: f.type.startsWith('video')?'video':'image', src: url, title: f.name || 'Nuevo contenido', meta:'Ahora', likes:0};
    feed.unshift(newItem);
    save(STORAGE_FEED, feed);
    renderFeed(); renderRows();
    uploadModal.classList.remove('show');
    alert('Contenido subido (demo local). Si quieres monetizar subidas reales, conecta backend + storage (Firebase/Supabase).');
    // optional: record an impression (new content surfaced)
    recordAdImpression(2);
  };
  reader.readAsDataURL(f);
}

/* -----------------------------
   Search overlay
   ----------------------------- */
const searchBtn = document.getElementById('searchBtn');
const searchOverlay = document.getElementById('searchOverlay');
const searchInput = document.getElementById('searchInput');
searchBtn.addEventListener('click', ()=> { searchOverlay.style.display = searchOverlay.style.display === 'block' ? 'none' : 'block'; if(searchOverlay.style.display==='block') setTimeout(()=>searchInput.focus(),80); });
searchInput.addEventListener('input', (e)=> filterFeed(e.target.value));
function filterFeed(q){
  q = (q||'').toLowerCase().trim();
  if(!q){ renderFeed(); renderRows(); return; }
  const filtered = feed.filter(it=> it.title.toLowerCase().includes(q));
  feedGrid.innerHTML=''; filtered.forEach(i=> feedGrid.appendChild(createFeedItem(i)));
  trendingRow.innerHTML=''; recentRow.innerHTML='';
  lazyObserveImages();
}

/* -----------------------------
   Navigation (UI only)
   ----------------------------- */
document.querySelectorAll('.nav-item').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    if(tab==='home'){ document.getElementById('scrollArea').scrollTo({top:0,behavior:'smooth'}); renderFeed(); renderRows(); }
    else if(tab==='explore'){ document.getElementById('scrollArea').scrollTo({top:document.getElementById('trendingRow').offsetTop-40,behavior:'smooth'}); }
    else if(tab==='likes'){ showLiked(); }
    else if(tab==='profile'){ alert('Perfil demo ‚Äî conectar backend'); }
  });
});
function showLiked(){
  const likedIds = Object.keys(load(STORAGE_LIKES, {}));
  const liked = feed.filter(f=> likedIds.includes(f.id));
  feedGrid.innerHTML=''; liked.forEach(i=> feedGrid.appendChild(createFeedItem(i)));
}

/* -----------------------------
   Lazy loading images (IntersectionObserver)
   ----------------------------- */
let imgObserver = null;
function lazyObserveImages(){
  const imgs = document.querySelectorAll('img[data-src]');
  if('IntersectionObserver' in window){
    if(!imgObserver){
      imgObserver = new IntersectionObserver((entries, obs)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            const img = entry.target;
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
            imgObserver.unobserve(img);
            // when an image is loaded and visible, count as an ad impression zone (simulate)
            recordAdImpression(1);
          }
        });
      }, {rootMargin:'200px', threshold:0.1});
    }
    imgs.forEach(i=> imgObserver.observe(i));
  } else {
    // fallback: load all
    imgs.forEach(i=> { i.src = i.dataset.src; i.removeAttribute('data-src'); recordAdImpression(1); });
  }
}

/* -----------------------------
   Init render
   ----------------------------- */
function init(){
  renderFeed();
  renderRows();
  updateDashboardKPIs();
  // Register service worker (optional). Create sw.js in your repo for production.
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sinfiltro/sw.js').catch(e=> console.log('Service worker not registered (add /sinfiltro/sw.js to enable):',e));
  }
  // Respect reduced motion
  if(window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    document.querySelectorAll('*').forEach(n=> n.style.animation='none');
  }
}
init();

/* -----------------------------
   Helper: createFeedItem used in filter
   ----------------------------- */
function createFeedItem(item){
  const el = document.createElement('article');
  el.className = 'feed-item';
  el.innerHTML = `<img data-src="${item.src}" alt="${escapeHtml(item.title)}"><div class="feed-body"><div class="feed-title">${escapeHtml(item.title)}</div><div class="feed-meta"><div>${escapeHtml(item.meta)}</div><div style="display:flex;gap:8px;align-items:center"><button class="like-btn" data-id="${item.id}">‚ù§ <span class="count">${item.likes||0}</span></button><button class="comment-btn" data-id="${item.id}">üí¨ <span class="count">${(comments[item.id]||[]).length}</span></button><button class="share-btn" data-id="${item.id}">üîó</button></div></div></div>`;
  el.querySelector('.like-btn').addEventListener('click', (e)=>{ e.stopPropagation(); toggleLike(item.id); });
  el.querySelector('.comment-btn').addEventListener('click', (e)=>{ e.stopPropagation(); openComments(item.id, item.title); });
  el.querySelector('.share-btn').addEventListener('click', (e)=>{ e.stopPropagation(); shareItem(item); });
  el.addEventListener('click', ()=> openViewer(item.id));
  return el;
}

/* -----------------------------
   Notes for real monetization integration
   -----------------------------
   1) Ads: Insert real ad provider script (AdSense) into the <head> and implement ad slots
      where you want them. Use the provider documentation and your account ID (AD_NETWORK_ID).
   2) Shortener: Replace shortenLinkSim() with actual API call to your shortener service.
      Use webhooks to count real clicks server-side for accuracy.
   3) Subscriptions/payments: Integrate Stripe Checkout or PayPal Buttons.
      Use server-side endpoints (or Stripe Checkout Sessions) to handle payments securely.
   4) Marketplace: Use cloud storage (Firebase Storage / Supabase Storage) and a backend to
      process payments and transfer funds (Stripe Connect to send payouts to sellers).
   5) Dashboard: Instead of localStorage, aggregate real metrics from providers (AdSense API,
      shortener API, Stripe webhooks) into your server and show totals in the dashboard.
   6) PWA: Add /sinfiltro/manifest.json and /sinfiltro/sw.js files to your repo for installability.
*/

/* End of script */
</script>
</body>
</html>
```Ó®Å0Ó®Ç

