<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SinFiltro ‚Äî Playas Jardines</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
    #mapButton, #shootButton {
      position: absolute;
      border: none;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4a00e0, #8e2de2);
      box-shadow: 0 0 10px #0008;
      color: #fff;
      font-size: 24px;
      z-index: 10;
    }
    #shootButton {
      right: 110px;
      background: linear-gradient(135deg, #ff7a18, #af002d);
    }
    #fpsCounter {
      position: absolute;
      left: 10px;
      bottom: 10px;
      color: white;
      background: #0008;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <button id="shootButton">üî´</button>
  <button id="mapButton">üó∫Ô∏è</button>
  <div id="fpsCounter">FPS: 0</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/osmtogeojson@3.0.0/osmtogeojson.js"></script>

  <script>
    const canvas = document.getElementById('canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 10);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0, 0);
    controls.enableDamping = true;

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 20, 10);
    light.castShadow = true;
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    // Suelo
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(500, 500),
      new THREE.MeshStandardMaterial({ color: 0x333333 })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Veh√≠culo
    const car = new THREE.Group();
    const body = new THREE.Mesh(
      new THREE.BoxGeometry(2, 1, 4),
      new THREE.MeshStandardMaterial({ color: 0xaa0000 })
    );
    body.castShadow = true;
    car.add(body);

    const gun = new THREE.Mesh(
      new THREE.CylinderGeometry(0.1, 0.1, 2),
      new THREE.MeshStandardMaterial({ color: 0xffd700 })
    );
    gun.rotation.z = Math.PI / 2;
    gun.position.set(1.5, 0.5, 0);
    car.add(gun);

    scene.add(car);

    // Movimiento
    let velocity = 0;
    const keys = {};
    document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    // Disparo
    const projectiles = [];
    document.getElementById('shootButton').onclick = () => {
      const bullet = new THREE.Mesh(
        new THREE.SphereGeometry(0.1, 8, 8),
        new THREE.MeshBasicMaterial({ color: 0xffff00 })
      );
      bullet.position.copy(gun.getWorldPosition(new THREE.Vector3()));
      bullet.userData.velocity = new THREE.Vector3(Math.cos(car.rotation.y), 0, Math.sin(car.rotation.y)).multiplyScalar(-0.8);
      scene.add(bullet);
      projectiles.push(bullet);
    };

    // Calles desde OpenStreetMap
    async function loadMap() {
      const bbox = [-99.0285, 19.6038, -99.015, 19.612]; // Playas Jardines de Morelos
      const url = `https://api.openstreetmap.org/api/0.6/map?bbox=${bbox.join(',')}`;
      const res = await fetch(url);
      const text = await res.text();
      const xml = new DOMParser().parseFromString(text, 'text/xml');
      const geojson = osmtogeojson(xml);

      const roadMat = new THREE.LineBasicMaterial({ color: 0x00ffff });
      geojson.features.forEach(f => {
        if (f.geometry.type === 'LineString') {
          const points = f.geometry.coordinates.map(([lon, lat]) => {
            const x = (lon - bbox[0]) * 10000;
            const z = (lat - bbox[1]) * 10000;
            return new THREE.Vector3(x, 0.01, z);
          });
          const geom = new THREE.BufferGeometry().setFromPoints(points);
          const line = new THREE.Line(geom, roadMat);
          scene.add(line);
        }
      });
    }
    loadMap();

    // FPS y animaci√≥n
    let last = performance.now(), frames = 0;
    function animate() {
      requestAnimationFrame(animate);
      controls.update();

      if (keys['w']) velocity += 0.02;
      if (keys['s']) velocity -= 0.02;
      if (keys['a']) car.rotation.y += 0.05;
      if (keys['d']) car.rotation.y -= 0.05;

      velocity *= 0.95;
      car.position.x -= Math.sin(car.rotation.y) * velocity;
      car.position.z -= Math.cos(car.rotation.y) * velocity;

      projectiles.forEach((b, i) => {
        b.position.add(b.userData.velocity);
        if (b.position.length() > 300) {
          scene.remove(b);
          projectiles.splice(i, 1);
        }
      });

      renderer.render(scene, camera);

      // FPS Counter
      frames++;
      const now = performance.now();
      if (now - last >= 1000) {
        document.getElementById('fpsCounter').textContent = `FPS: ${frames}`;
        frames = 0; last = now;
      }
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
