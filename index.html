<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SinFiltro â€” Playas JM (MVP mÃ³vil)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1:#05060a; --bg-2:#071226;
    --accent-cyan:#00d1ff; --accent-violet:#8a6eff;
    --muted:#9fb0bf; --glass: rgba(255,255,255,0.04);
    --radius:12px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#eaf7ff;font-family:Inter,system-ui;overflow:hidden;-webkit-font-smoothing:antialiased}
  /* Holder */
  #holder{position:fixed;inset:0;touch-action:none}
  /* UI overlay */
  .topbar{position:fixed;left:10px;right:10px;top:10px;z-index:120;display:flex;justify-content:space-between;align-items:center;gap:8px;pointer-events:auto}
  .brand{font-family:Poppins,system-ui;font-weight:700;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-violet));-webkit-background-clip:text;background-clip:text;color:transparent;padding:8px 10px;border-radius:10px}
  .controls{display:flex;gap:8px}
  .chip{padding:8px 12px;border-radius:12px;background:rgba(255,255,255,0.03);color:var(--muted);font-weight:600;cursor:pointer;backdrop-filter:blur(6px)}
  /* joystick / fire */
  .joy{position:fixed;left:18px;bottom:18px;width:104px;height:104px;border-radius:999px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;z-index:130;pointer-events:auto;touch-action:none}
  .stick{width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,0.06);transform:translate(0,0)}
  .fire{position:fixed;right:18px;bottom:32px;width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-violet));display:flex;align-items:center;justify-content:center;z-index:130;pointer-events:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
  /* minimap & stats */
  .minimap{position:fixed;right:12px;bottom:120px;width:110px;height:110px;border-radius:12px;background:rgba(0,0,0,0.55);z-index:125;display:flex;align-items:center;justify-content:center;pointer-events:auto;box-shadow:0 12px 30px rgba(0,0,0,0.6)}
  .fps{position:fixed;left:12px;bottom:120px;background:rgba(0,0,0,0.55);padding:6px 10px;border-radius:10px;font-weight:600;z-index:125}
  .info{position:fixed;left:12px;bottom:80px;background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:10px;z-index:125}
  /* viewer */
  #viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:220}
  /* responsive */
  @media(max-width:420px){ .joy{width:92px;height:92px} .stick{width:40px;height:40px} .fire{width:60px;height:60px} .minimap{width:88px;height:88px} .chip{padding:6px 10px;font-size:13px} }
</style>
</head>
<body>
  <div id="holder"></div>

  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <button id="brandBtn" class="brand" aria-label="SinFiltro">SinFiltro</button>
      <div id="loadingChip" class="chip">Cargando callesâ€¦</div>
    </div>
    <div class="controls">
      <div id="btnSat" class="chip">SatÃ©lite: OFF</div>
      <div id="btnRecenter" class="chip">Re-cent.</div>
    </div>
  </div>

  <div class="joy" id="joy"><div class="stick" id="stick"></div></div>
  <div class="fire" id="fire" aria-label="disparar">ðŸ”«</div>
  <div class="minimap" id="minimap"><canvas id="mm" width="256" height="256" style="width:100%;height:100%;border-radius:10px"></canvas></div>
  <div class="fps" id="fps">FPS: --</div>
  <div class="info" id="info">Modo demo â€” Playas JM (representaciÃ³n)</div>

  <div id="viewer" role="dialog" aria-hidden="true">
    <div style="text-align:center">
      <img id="viewerImg" src="" alt="preview" style="max-width:90%;height:auto;border-radius:12px"><br><br>
      <button id="closeViewer" style="padding:8px 12px;border-radius:8px">Cerrar</button>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script>
  (function(){
    // ---------- Config & scene ----------
    const holder = document.getElementById('holder');

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x05060a, 0.002);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.4));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    holder.appendChild(renderer.domElement);
    renderer.domElement.style.touchAction = 'none'; // allow custom touch handling

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(0,6,12);

    const light = new THREE.DirectionalLight(0xffffff, 0.9); light.position.set(5,10,7); scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.28));

    // Ground base
    const groundMat = new THREE.MeshStandardMaterial({color:0x0b1220, roughness:0.95, metalness:0.02});
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1500,1500), groundMat);
    ground.rotation.x = -Math.PI/2; ground.position.y = 0;
    scene.add(ground);

    // ---------- Simple "Playas JM" streets layout (hand-placed segments)
    // We'll create a minimal, representative network: 3 paralelas grandes (E-W) + 3 vertical connectors (N-S)
    // Coordinates are in "scene units" (meters scaled for mobile). This is a simplified, playable map.
    const roadsGroup = new THREE.Group(); scene.add(roadsGroup);
    const buildingsGroup = new THREE.Group(); scene.add(buildingsGroup);

    // Utility: create road segment between two points (vec3)
    function makeRoadSegment(a,b,width=2){
      const len = a.distanceTo(b);
      const geom = new THREE.BoxGeometry(width, 0.02, Math.max(len,0.1));
      const mat = new THREE.MeshStandardMaterial({color:0x181b22, roughness:0.95, metalness:0.02});
      const m = new THREE.Mesh(geom, mat);
      const mid = a.clone().add(b).multiplyScalar(0.5);
      m.position.copy(mid); m.position.y = 0.01;
      // align
      const look = new THREE.Vector3().copy(b).sub(a);
      const angle = Math.atan2(look.x, look.z);
      m.rotation.y = angle;
      roadsGroup.add(m);
      return m;
    }

    // Define nodes in scene units (small map)
    // We'll pick scale so car fits; coordinates roughly form grid
    const mapNodes = {
      A: new THREE.Vector3(-18,0,-24),
      B: new THREE.Vector3(18,0,-24),
      C: new THREE.Vector3(-18,0,0),
      D: new THREE.Vector3(18,0,0),
      E: new THREE.Vector3(-18,0,24),
      F: new THREE.Vector3(18,0,24),
      // vertical connectors (center lines)
      G: new THREE.Vector3(0,0,-30),
      H: new THREE.Vector3(0,0,30)
    };

    // horizontal main roads (E-W)
    makeRoadSegment(mapNodes.A, mapNodes.B, 4.0);
    makeRoadSegment(mapNodes.C, mapNodes.D, 4.0);
    makeRoadSegment(mapNodes.E, mapNodes.F, 4.0);
    // connectors (N-S)
    makeRoadSegment(mapNodes.G, mapNodes.H, 3.0);
    makeRoadSegment(new THREE.Vector3(-9,0,-30), new THREE.Vector3(-9,0,30), 2.2);
    makeRoadSegment(new THREE.Vector3(9,0,-30), new THREE.Vector3(9,0,30), 2.2);

    // record polylines for soft constrain
    const roadPolylines = [
      [ mapNodes.A.clone(), mapNodes.C.clone(), mapNodes.E.clone() ],
      [ mapNodes.B.clone(), mapNodes.D.clone(), mapNodes.F.clone() ],
      [ new THREE.Vector3(-9,0,-30), new THREE.Vector3(-9,0,30) ],
      [ new THREE.Vector3(9,0,-30), new THREE.Vector3(9,0,30) ],
      [ mapNodes.G.clone(), mapNodes.H.clone() ]
    ];

    // Simple buildings along roads (boxes)
    function addBuilding(x,z,w,l,h,color=0x0f1620){
      const g = new THREE.BoxGeometry(w, h, l);
      const m = new THREE.Mesh(g, new THREE.MeshStandardMaterial({color,color,roughness:0.95}));
      m.position.set(x, h/2, z);
      buildingsGroup.add(m);
    }
    // spawn a few buildings to give the feeling of neighborhood (sparse, low-poly)
    addBuilding(-26, -22, 8, 10, 4);
    addBuilding(-6, -22, 6, 8, 3.8);
    addBuilding(12, -22, 7, 9, 4.2);
    addBuilding(-26, 2, 8, 10, 5);
    addBuilding(14, 2, 6, 7, 3.5);
    addBuilding(-10, 22, 6, 8, 4.8);
    addBuilding(20, 22, 10, 12, 5.5);

    // small lamp posts for ambience
    function addLamp(x,z){
      const s = new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,2,6), new THREE.MeshStandardMaterial({color:0x222222}));
      s.position.set(x,1,z); scene.add(s);
    }
    addLamp(-10,-8); addLamp(10,-8); addLamp(-10,8); addLamp(10,8);

    // ---------- Player (car) - low poly ----------
    const car = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.7,4.2), new THREE.MeshStandardMaterial({color:0xff5555, metalness:0.2, roughness:0.6}));
    body.position.y = 0.7; car.add(body);
    const wheelGeo = new THREE.CylinderGeometry(0.32,0.32,0.5,8);
    const wheelMat = new THREE.MeshStandardMaterial({color:0x111111});
    for(let i=0;i<4;i++){
      const w = new THREE.Mesh(wheelGeo, wheelMat); w.rotation.z = Math.PI/2; w.position.y = 0.25;
      w.position.x = (i%2===0)?-0.95:0.95; w.position.z = (i<2)?1.1:-1.1; car.add(w);
    }
    car.position.set(0,0,0); scene.add(car);

    // set initial car on middle road
    car.position.copy(mapNodes.C);

    // ---------- Movement & physics ----------
    const state = {forward:0, turn:0, speed:0, maxSpeed:0.95, rotSpeed:0.045};
    let stick = {x:0,y:0};

    // soft constrain to roads (pull towards nearest polyline)
    function constrainToRoad(pos){
      let best = {dist:1e9, nearest:null};
      for(const poly of roadPolylines){
        for(let i=0;i<poly.length-1;i++){
          const a = poly[i], b = poly[i+1];
          const ap = pos.clone().sub(a);
          const ab = b.clone().sub(a);
          const abLen2 = ab.lengthSq();
          if(abLen2 === 0) continue;
          const t = Math.max(0, Math.min(1, ap.dot(ab)/abLen2));
          const proj = a.clone().add(ab.clone().multiplyScalar(t));
          const d = proj.distanceTo(pos);
          if(d < best.dist){ best.dist = d; best.nearest = proj; }
        }
      }
      if(!best.nearest) return;
      const maxLat = 2.0;
      if(best.dist > maxLat){
        const dir = best.nearest.clone().sub(pos).multiplyScalar(0.3);
        pos.add(dir);
      }
    }

    // bullets
    const bullets = [];
    function spawnBullet(origin, dir){
      const g = new THREE.SphereGeometry(0.12, 6,6);
      const m = new THREE.Mesh(g, new THREE.MeshStandardMaterial({emissive:0xffcc77, color:0x222222}));
      m.position.copy(origin);
      m.userData = {dir: dir.clone(), speed: 2.6};
      scene.add(m); bullets.push(m);
    }

    // ---------- Input handling (joystick + fire) ----------
    const joy = document.getElementById('joy'), stickEl = document.getElementById('stick');
    let touchId = null, baseX=0, baseY=0, isPointerDown=false;
    function resetStick(){ stick={x:0,y:0}; stickEl.style.transform='translate(0px,0px)'; }
    joy.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.changedTouches[0]; touchId=t.identifier; baseX=t.clientX; baseY=t.clientY; }, {passive:false});
    joy.addEventListener('touchmove', e=>{ e.preventDefault(); for(const t of e.changedTouches){ if(t.identifier===touchId){ const dx=t.clientX-baseX, dy=t.clientY-baseY, max=36; const nx=Math.max(-1,Math.min(1,dx/max)), ny=Math.max(-1,Math.min(1,dy/max)); stick.x = nx; stick.y = -ny; stickEl.style.transform=`translate(${nx*28}px,${-ny*28}px)`; } } }, {passive:false});
    joy.addEventListener('touchend', e=>{ for(const t of e.changedTouches){ if(t.identifier===touchId){ touchId=null; resetStick(); } } }, {passive:false});
    // pointer events for desktop
    joy.addEventListener('pointerdown', e=>{ isPointerDown=true; baseX=e.clientX; baseY=e.clientY; joy.setPointerCapture(e.pointerId); });
    joy.addEventListener('pointermove', e=>{ if(!isPointerDown) return; const dx=e.clientX-baseX, dy=e.clientY-baseY, max=36; const nx=Math.max(-1,Math.min(1,dx/max)), ny=Math.max(-1,Math.min(1,dy/max)); stick.x=nx; stick.y=-ny; stickEl.style.transform=`translate(${nx*28}px,${-ny*28}px)`; });
    joy.addEventListener('pointerup', e=>{ isPointerDown=false; resetStick(); });

    const fireBtn = document.getElementById('fire');
    fireBtn.addEventListener('touchstart', e=>{ e.preventDefault(); doFire(); }, {passive:false});
    fireBtn.addEventListener('mousedown', doFire);
    function doFire(){
      const dir = new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion).normalize();
      const origin = car.position.clone().add(new THREE.Vector3(0,0.9,-2).applyQuaternion(car.quaternion));
      spawnBullet(origin, dir);
    }

    // ---------- Minimap rendering ----------
    const mm = document.getElementById('mm'); const mmCtx = mm.getContext('2d');
    function drawMinimap(){
      mmCtx.clearRect(0,0,256,256);
      mmCtx.fillStyle = '#07101a'; mmCtx.fillRect(0,0,256,256);
      mmCtx.strokeStyle = '#bfe9ff'; mmCtx.lineWidth = 2;
      // draw road polylines scaled
      const scale = 3.2; // tweak to fit
      mmCtx.beginPath();
      for(const poly of roadPolylines){
        for(let i=0;i<poly.length;i++){
          const p = poly[i];
          const x = 128 + p.x * scale;
          const y = 128 + p.z * scale;
          if(i===0) mmCtx.moveTo(x,y); else mmCtx.lineTo(x,y);
        }
      }
      mmCtx.stroke();
      // player
      const px = 128 + car.position.x * scale; const py = 128 + car.position.z * scale;
      mmCtx.fillStyle = '#ff6666'; mmCtx.beginPath(); mmCtx.arc(px,py,4,0,Math.PI*2); mmCtx.fill();
    }

    // ---------- Satellite toggle (simple image overlay on ground) ----------
    let satEnabled = false;
    let satTex = null;
    async function loadSat(){
      if(satTex) return true;
      try{
        const url = 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1024&h=1024&fit=crop'; // placeholder satellite-like
        const img = await new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=url; });
        satTex = new THREE.CanvasTexture(img);
        satTex.encoding = THREE.sRGBEncoding;
        return true;
      }catch(e){ console.warn('sat load fail',e); return false; }
    }
    function setSat(on){
      if(on && satTex){
        ground.material = new THREE.MeshBasicMaterial({map: satTex});
        satEnabled=true; document.getElementById('btnSat').textContent='SatÃ©lite: ON';
      } else {
        ground.material = groundMat;
        satEnabled=false; document.getElementById('btnSat').textContent='SatÃ©lite: OFF';
      }
    }
    document.getElementById('btnSat').addEventListener('click', async ()=>{
      if(!satTex){ document.getElementById('btnSat').textContent='SatÃ©lite: Cargandoâ€¦'; await loadSat(); }
      setSat(!satEnabled);
    });

    // recenter
    document.getElementById('btnRecenter').addEventListener('click', ()=>{
      car.position.set(0,0,0); car.rotation.set(0,0,0); camera.position.set(0,6,12);
    });

    // brand click -> open viewer (preview)
    document.getElementById('brandBtn').addEventListener('click', ()=>{
      document.getElementById('viewerImg').src = 'https://picsum.photos/800/420?random=77';
      document.getElementById('viewer').style.display='flex';
    });
    document.getElementById('closeViewer').addEventListener('click', ()=> document.getElementById('viewer').style.display='none');

    // ---------- Render loop & updates ----------
    let last = performance.now(), fpsLast = performance.now(), frames = 0;
    function animate(){
      const now = performance.now();
      const dt = Math.min(50, now-last) / 16.666; last = now;
      // map stick to motion
      state.forward = Math.max(-1, Math.min(1, stick.y));
      state.turn = Math.max(-1, Math.min(1, stick.x));
      // speed
      if(state.forward > 0.05) state.speed += 0.018 * state.forward * dt;
      else if(state.forward < -0.05) state.speed -= 0.03 * (-state.forward) * dt;
      else state.speed *= 0.96;
      state.speed = Math.max(-state.maxSpeed, Math.min(state.maxSpeed, state.speed));
      // rotation & move
      car.rotation.y += -state.turn * state.rotSpeed * (0.9 + Math.abs(state.speed)) * dt;
      const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion);
      car.position.add(fwd.multiplyScalar(state.speed * dt * 0.86));
      // constrain gently to roads
      constrainToRoad(car.position);
      // bullets update & cleanup
      for(let i=bullets.length-1;i>=0;i--){
        const b = bullets[i]; b.position.add(b.userData.dir.clone().multiplyScalar(b.userData.speed * dt));
        if(b.position.length() > 1000){ scene.remove(b); bullets.splice(i,1); }
      }
      // camera smoothing
      const desiredCam = car.position.clone().add(new THREE.Vector3(0,4,10).applyQuaternion(car.quaternion));
      camera.position.lerp(desiredCam, 0.14);
      camera.lookAt(car.position.clone().add(new THREE.Vector3(0,1.2,0)));
      // render
      renderer.render(scene, camera);
      // fps calc
      frames++; if(now - fpsLast >= 500){ const fpsNow = Math.round((frames*1000)/(now-fpsLast)); frames=0; fpsLast=now; document.getElementById('fps').textContent = `FPS: ${fpsNow}`; }
      // minimap
      drawMinimap();
      requestAnimationFrame(animate);
    }

    // ---------- Resize ----------
    function onResize(){ renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); }
    window.addEventListener('resize', onResize, {passive:true});

    // ---------- Simple performance optimizations ----------
    // - low poly geometry, few lights
    // - renderer pixel ratio capped above
    // - avoid heavy materials
    // - lazy load satellite image only on demand

    // ---------- Final init ----------
    // hide loading chip once ready
    document.getElementById('loadingChip').style.display = 'none';
    document.getElementById('loadingChip').textContent = 'Listo';

    // place car onto nearest road center (simple nearest polyline center)
    if(roadPolylines.length){
      const p = roadPolylines[0][ Math.floor(roadPolylines[0].length/2) ];
      if(p) car.position.copy(p);
    }

    requestAnimationFrame(animate);

    // Touch behaviour: ensure renderer doesn't block UI clicks (we allowed touchAction none)
    renderer.domElement.style.touchAction = 'none';

    // Safety: expose some objects for debugging in console (optional)
    window.__SIN = { scene, car, roadsGroup, buildingsGroup, roadPolylines };

    // mark map loaded (UI)
    document.getElementById('loadingChip').style.display='inline-block';
    setTimeout(()=>{ document.getElementById('loadingChip').textContent = 'Calles: cargadas (modo demo)'; }, 600);

  })();
  </script>
</body>
</html>
