<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SinFiltro â€” Playa Azul (versiÃ³n C+ satÃ©lite Esri)</title>
<style>
  :root{--bg:#05060a;--ui:#0b1220;--accent1:#00d1ff;--accent2:#8a6eff;--muted:#9fb0bf}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071226);font-family:Inter,system-ui,Arial;color:#eaf7ff;overflow:hidden}
  #holder{width:100%;height:100%;position:fixed;inset:0;display:block}
  .topbar{position:fixed;left:10px;right:10px;top:8px;height:54px;display:flex;align-items:center;gap:8px;z-index:220}
  .brand{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;font-weight:700}
  .btn{padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001;font-weight:700;cursor:pointer}
  .tbtn{padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
  .hud{position:fixed;left:12px;bottom:12px;z-index:220;display:flex;flex-direction:column;gap:8px}
  .fps{background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:10px;color:var(--muted);font-size:13px}
  .minimap{position:fixed;right:12px;bottom:12px;width:110px;height:110px;background:rgba(2,10,18,0.8);border-radius:10px;padding:6px;z-index:220;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .joy { position:fixed; left:18px; bottom:18px; width:110px; height:110px; border-radius:60px; background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; pointer-events:auto; z-index:210 }
  .stick { width:48px; height:48px; border-radius:50%; background:rgba(255,255,255,0.06); transform:translate(0,0) }
  .fire { position:fixed; right:18px; bottom:32px; width:72px; height:72px; border-radius:50%; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#001; display:flex;align-items:center;justify-content:center;z-index:210;box-shadow:0 16px 50px rgba(0,0,0,0.5) }
  .debugLbl{position:fixed;left:12px;bottom:84px;background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:10px;color:var(--muted);z-index:220}
  @media (max-width:420px){ .brand{font-size:14px} .minimap{width:90px;height:90px} .joy{width:96px;height:96px} .stick{width:42px;height:42px} .fire{width:64px;height:64px} }
</style>
</head>
<body>
  <div id="holder"></div>
  <div class="topbar">
    <div class="brand">SinFiltro â€” Playa Azul (C+ SatÃ©lite)</div>
    <div style="flex:1"></div>
    <button id="toggleStreets" class="tbtn">Calles: ON</button>
    <button id="toggleSatellite" class="tbtn">SatÃ©lite: ON</button>
    <button id="recenter" class="btn">Re-centar</button>
  </div>
  <div class="hud"><div id="infoCount" class="fps">Cargando calles...</div></div>
  <div class="minimap" id="minimap"></div>
  <div class="debugLbl" id="debugLbl">FPS: --</div>
  <div class="joy" id="joy"><div class="stick" id="stick"></div></div>
  <div class="fire" id="fire">ðŸ”«</div>
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script>
/* Config general */
const CENTER_LAT = 19.605200;
const CENTER_LON = -99.000289;
const BBOX_HALF_DEG = 0.01;
const TILE_URL_TEMPLATE = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
const STREET_WIDTH = 6;
const STREET_HEIGHT = 0.02;
const COLLISION_MARGIN = 0.6;
const MAX_WAYS_TO_DRAW = 4000;
const SIMPLIFY_TOLERANCE = 0.00002;

/* ConversiÃ³n lat/lon â†’ metros */
const metersPerDegLat = 111320;
const metersPerDegLon = lat=>Math.cos(lat*Math.PI/180)*111320;
function latLonToXY(lat,lon){ const dx=(lon-CENTER_LON)*metersPerDegLon(CENTER_LAT); const dz=(lat-CENTER_LAT)*metersPerDegLat; return new THREE.Vector3(dx,0,-dz); }

/* Scene base */
const holder=document.getElementById('holder');
const scene=new THREE.Scene(); scene.background=new THREE.Color(0x05060a); scene.fog=new THREE.FogExp2(0x05060a,0.0009);
const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(innerWidth,innerHeight); holder.appendChild(renderer.domElement);
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,5000); camera.position.set(0,6,12);
scene.add(new THREE.DirectionalLight(0xffffff,0.9).position.set(5,10,7)); scene.add(new THREE.AmbientLight(0xffffff,0.25));

/* Ground + textura satÃ©lite Esri */
const groundMat=new THREE.MeshStandardMaterial({color:0x0b1220});
const ground=new THREE.Mesh(new THREE.PlaneGeometry(5000,5000),groundMat);
ground.rotation.x=-Math.PI/2; scene.add(ground);
const loader=new THREE.TextureLoader(); function applySatellite(){ const z=16, xyz=latLonToTile(CENTER_LAT,CENTER_LON,z); const url=TILE_URL_TEMPLATE.replace('{z}',z).replace('{x}',xyz.x).replace('{y}',xyz.y); loader.load(url,t=>{t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(8,8);ground.material.map=t;ground.material.needsUpdate=true;});}
function latLonToTile(lat,lon,z){const xtile=Math.floor((lon+180)/360*Math.pow(2,z));const latRad=lat*Math.PI/180;const ytile=Math.floor((1-Math.log(Math.tan(latRad)+1/Math.cos(latRad))/Math.PI)/2*Math.pow(2,z));return{x:xtile,y:ytile,z};}
applySatellite();

/* Player */
const player=new THREE.Group(); const body=new THREE.Mesh(new THREE.BoxGeometry(2.2,0.7,4.2),new THREE.MeshStandardMaterial({color:0xff5555}));
body.position.y=0.7; player.add(body); scene.add(player);

/* Calles y colisiones */
const streetGroup=new THREE.Group(); scene.add(streetGroup);
let collisionSegments=[];

/* Minimap */
const mmCanvas=document.createElement('canvas');mmCanvas.width=256;mmCanvas.height=256;document.getElementById('minimap').appendChild(mmCanvas);
const mmCtx=mmCanvas.getContext('2d');

/* UI */
const info=document.getElementById('infoCount'),debugLbl=document.getElementById('debugLbl');
document.getElementById('toggleStreets').onclick=()=>{streetGroup.visible=!streetGroup.visible};
document.getElementById('toggleSatellite').onclick=()=>{ground.material.map?ground.material.map=null:applySatellite();};
document.getElementById('recenter').onclick=()=>{player.position.set(0,0,0);player.rotation.set(0,0,0);camera.position.set(0,6,12);};

/* Joystick */
let stick={x:0,y:0};const joy=document.getElementById('joy'),stickEl=document.getElementById('stick');
let touchId=null,baseX=0,baseY=0;function resetStick(){stick={x:0,y:0};stickEl.style.transform='translate(0,0)';}
joy.addEventListener('touchstart',e=>{const t=e.touches[0];touchId=t.identifier;baseX=t.clientX;baseY=t.clientY;});
joy.addEventListener('touchmove',e=>{for(const t of e.touches){if(t.identifier===touchId){const dx=t.clientX-baseX,dy=t.clientY-baseY;const max=36;stick.x=Math.max(-1,Math.min(1,dx/max));stick.y=-Math.max(-1,Math.min(1,dy/max));stickEl.style.transform=`translate(${stick.x*28}px,${-stick.y*28}px)`;}}});
joy.addEventListener('touchend',()=>resetStick());

/* Movimiento */
const state={speed:0,max:0.9,rot:0.04};
function move(dt){state.speed+=stick.y*0.02*dt;state.speed*=0.98;state.speed=Math.max(-state.max,Math.min(state.max,state.speed));
player.rotation.y+=-stick.x*state.rot*dt;
const f=new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
player.position.add(f.multiplyScalar(state.speed*dt));}

/* Disparo */
document.getElementById('fire').onclick=()=>{const dir=new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);const b=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8),new THREE.MeshStandardMaterial({emissive:0xffaa33}));b.position.copy(player.position.clone().add(dir.clone().multiplyScalar(2)));b.userData.dir=dir;b.userData.speed=3;scene.add(b);bullets.push(b);};
const bullets=[];

/* OSM fetch */
async function fetchOSM(){const s=CENTER_LAT-BBOX_HALF_DEG,n=CENTER_LAT+BBOX_HALF_DEG,w=CENTER_LON-BBOX_HALF_DEG,e=CENTER_LON+BBOX_HALF_DEG;
const q=`[out:json][timeout:25];(way["highway"~"motorway|trunk|primary|secondary|tertiary|residential|service|road"](${s},${w},${n},${e}););out body;>;out skel qt;`;
const res=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q});return await res.json();}
function buildWays(d){const nodes={};for(const el of d.elements)if(el.type==='node')nodes[el.id]=el;
const ways=[];for(const el of d.elements)if(el.type==='way'){const ns=el.nodes.map(i=>nodes[i]).filter(Boolean);
if(ns.length>1){const simp=[ns[0]];for(let i=1;i<ns.length;i++){if(Math.abs(ns[i].lat-simp.at(-1).lat)>SIMPLIFY_TOLERANCE||Math.abs(ns[i].lon-simp.at(-1).lon)>SIMPLIFY_TOLERANCE)simp.push(ns[i]);}ways.push({nodes:simp});}}return ways;}
function makeStreets(ws){streetGroup.clear();collisionSegments=[];
const mat=new THREE.MeshStandardMaterial({color:0x202830});
for(const w of ws){const pts=w.nodes.map(n=>latLonToXY(n.lat,n.lon));for(let i=0;i<pts.length-1;i++){const a=pts[i],b=pts[i+1];
const dir=new THREE.Vector3().subVectors(b,a).normalize(),left=new THREE.Vector3(-dir.z,0,dir.x).multiplyScalar(STREET_WIDTH/2);
const r1=a.clone().add(left),r2=a.clone().sub(left),r3=b.clone().add(left),r4=b.clone().sub(left);
const geom=new THREE.BufferGeometry().setAttribute('position',new THREE.Float32BufferAttribute([...r1.toArray(),...r2.toArray(),...r3.toArray(),...r3.toArray(),...r2.toArray(),...r4.toArray()],3));
geom.computeVertexNormals();streetGroup.add(new THREE.Mesh(geom,mat));collisionSegments.push({a,b,halfWidth:STREET_WIDTH/2+COLLISION_MARGIN});}}}
fetchOSM().then(d=>{const ws=buildWays(d);makeStreets(ws);info.textContent=`Calles: ${ws.length}`;});

/* Minimapa */
function drawMinimap(){const ctx=mmCtx;ctx.clearRect(0,0,256,256);ctx.fillStyle='#0b1220';ctx.fillRect(0,0,256,256);ctx.fillStyle='#ff5555';ctx.beginPath();ctx.arc(128,128,5,0,6.28);ctx.fill();}

/* Bucle */
let lt=performance.now(),lfps=lt;
function loop(){const now=performance.now(),dt=(now-lt)/16.66;lt=now;move(dt);
for(let i=bullets.length-1;i>=0;i--){const b=bullets[i];b.position.add(b.userData.dir.clone().multiplyScalar(b.userData.speed*dt));if(b.position.length()>2000){scene.remove(b);bullets.splice(i,1);}}
camera.position.lerp(player.position.clone().add(new THREE.Vector3(0,4,10).applyQuaternion(player.quaternion)),0.1);
camera.lookAt(player.position.clone().add(new THREE.Vector3(0,1,0)));
renderer.render(scene,camera);
if(now-lfps>500){debugLbl.textContent=`FPS: ${Math.round(1000/(now-lt))}`;lfps=now;}
requestAnimationFrame(loop);}
loop();
  </script>
</body>
</html>
